/**
 * Comprehensive test of YouTube APIs - WORKING VERSION
 * Tests both youtube-api.js (metadata) and transcript-fetcher.js (transcripts)
 */

import { getVideoMetadata, checkCaptionAvailability, extractVideoId, formatDuration, formatViewCount } from './youtube-api.js';
import { getTranscript, searchTranscript, getTranscriptStats, chunkTranscript, exportAsText } from './transcript-fetcher.js';

const TEST_VIDEOS = [
  {
    name: 'Rick Astley - Never Gonna Give You Up',
    id: 'dQw4w9WgXcQ',
    hasTranscript: true
  },
  {
    name: 'Khan Academy - Introduction to Algebra',
    url: 'https://www.youtube.com/watch?v=V_xMV96ud3M',
    hasTranscript: true
  }
];

console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
console.log('‚ïë   YouTube API Test Suite - Phase 8 Implementation          ‚ïë');
console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');

async function runTests() {
  let passedTests = 0;
  let failedTests = 0;

  for (const video of TEST_VIDEOS) {
    const videoId = video.id || video.url;
    console.log(`\n${'='.repeat(60)}`);
    console.log(`Testing: ${video.name}`);
    console.log(`Video: ${videoId}`);
    console.log('='.repeat(60));

    try {
      // Test 1: Video Metadata
      console.log('\n[1/6] Fetching video metadata...');
      const metadata = await getVideoMetadata(videoId);
      
      if (metadata && metadata.title) {
        console.log('  ‚úÖ Title:', metadata.title);
        console.log('  ‚úÖ Author:', metadata.author);
        console.log('  ‚úÖ Duration:', formatDuration(metadata.duration));
        console.log('  ‚úÖ Views:', formatViewCount(metadata.views));
        console.log('  ‚úÖ Upload:', metadata.uploadDate);
        passedTests++;
      } else {
        console.log('  ‚ùå Failed to get metadata');
        failedTests++;
      }

      // Test 2: Caption Availability
      console.log('\n[2/6] Checking caption availability...');
      const captions = await checkCaptionAvailability(videoId);
      
      if (captions && captions.available) {
        console.log('  ‚úÖ Captions available');
        console.log(`  ‚úÖ Languages: ${captions.languages.length}`);
        captions.languages.slice(0, 3).forEach(lang => {
          console.log(`     - ${lang.name} (${lang.code})${lang.isAutoGenerated ? ' [auto]' : ''}`);
        });
        passedTests++;
      } else {
        console.log('  ‚ö†Ô∏è  No captions available');
        passedTests++;
      }

      // Test 3: Transcript Fetching
      if (video.hasTranscript) {
        console.log('\n[3/6] Fetching transcript...');
        const transcript = await getTranscript(videoId);
        
        if (transcript && transcript.segments && transcript.segments.length > 0) {
          console.log(`  ‚úÖ Fetched ${transcript.segmentCount} segments`);
          console.log(`  ‚úÖ Total duration: ${Math.floor(transcript.totalDuration / 60)}m ${Math.floor(transcript.totalDuration % 60)}s`);
          console.log(`  ‚úÖ Word count: ${transcript.wordCount}`);
          
          console.log('\n  First 3 segments:');
          transcript.segments.slice(0, 3).forEach((seg, idx) => {
            console.log(`     [${seg.timestamp}] ${seg.text.substring(0, 60)}...`);
          });
          
          passedTests++;

          // Test 4: Transcript Statistics
          console.log('\n[4/6] Calculating transcript statistics...');
          const stats = getTranscriptStats(transcript);
          
          if (stats) {
            console.log(`  ‚úÖ Word count: ${stats.wordCount}`);
            console.log(`  ‚úÖ Unique words: ${stats.uniqueWordCount}`);
            console.log(`  ‚úÖ Avg words/segment: ${stats.averageWordsPerSegment.toFixed(1)}`);
            console.log(`  ‚úÖ Estimated reading time: ${stats.estimatedReadingTime} min`);
            passedTests++;
          } else {
            console.log('  ‚ùå Failed to calculate stats');
            failedTests++;
          }

          // Test 5: Search Functionality
          console.log('\n[5/6] Testing search functionality...');
          const searchTerm = video.id === 'dQw4w9WgXcQ' ? 'never gonna' : 'algebra';
          const searchResults = searchTranscript(transcript, searchTerm);
          
          if (searchResults && searchResults.length > 0) {
            console.log(`  ‚úÖ Found ${searchResults.length} matches for "${searchTerm}"`);
            const firstMatch = searchResults[0];
            console.log(`     [${firstMatch.match.timestamp}] "${firstMatch.match.text}"`);
            passedTests++;
          } else {
            console.log(`  ‚ö†Ô∏è  No matches found for "${searchTerm}"`);
            passedTests++;
          }

          // Test 6: Chunking for AI
          console.log('\n[6/6] Testing transcript chunking...');
          const chunks = chunkTranscript(transcript, 300); // 5-minute chunks
          
          if (chunks && chunks.length > 0) {
            console.log(`  ‚úÖ Split into ${chunks.length} chunks`);
            console.log(`     First chunk: ${chunks[0].segments.length} segments (${(chunks[0].endTime - chunks[0].startTime).toFixed(0)}s)`);
            passedTests++;
          } else {
            console.log('  ‚ùå Failed to chunk transcript');
            failedTests++;
          }

        } else {
          console.log('  ‚ùå Failed to fetch transcript');
          failedTests++;
        }
      } else {
        console.log('\n[3-6/6] Skipping transcript tests (no captions available)');
      }

    } catch (error) {
      console.log(`\n  ‚ùå ERROR: ${error.message}`);
      failedTests++;
    }
  }

  // Summary
  console.log('\n\n' + '='.repeat(60));
  console.log('TEST SUMMARY');
  console.log('='.repeat(60));
  console.log(`‚úÖ Passed: ${passedTests}`);
  console.log(`‚ùå Failed: ${failedTests}`);
  console.log(`üìä Total:  ${passedTests + failedTests}`);
  
  if (failedTests === 0) {
    console.log('\nüéâ ALL TESTS PASSED! Phase 8 YouTube APIs are working!');
    console.log('\nReady to proceed with:');
    console.log('  - Video UI integration');
    console.log('  - Multi-agent summarization');
    console.log('  - Graphic organizer generation');
  } else {
    console.log('\n‚ö†Ô∏è  Some tests failed. Review errors above.');
  }
}

runTests().catch(console.error);
