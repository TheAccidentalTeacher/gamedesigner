<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Game Level Editor</title>
    <link rel="stylesheet" href="style.css">
    <script src="tooltip.js"></script>
</head>
<body>
    <div id="app">
        <!-- Top Toolbar -->
        <div id="toolbar">
            <h1>üéÆ Game Level Editor</h1>
            <div class="toolbar-buttons">
                <button id="load-background" title="Load background image (Ctrl+B)">üì∑ Load Background</button>
                <button id="add-asset" title="Add sprite/asset (Ctrl+A)">‚ûï Add Asset</button>
                <button id="export-json" title="Export to JSON (Ctrl+E)">üíæ Export JSON</button>
                <button id="save-project" title="Save project file (Ctrl+S)">üìÅ Save Project</button>
                <button id="load-project" title="Load project file (Ctrl+O)">üìÇ Load Project</button>
                <button id="clear-all" title="Clear everything">üóëÔ∏è Clear All</button>
            </div>
        </div>

        <!-- Main Workspace -->
        <div id="workspace">
            <!-- Canvas -->
            <div id="canvas-container">
                <canvas id="canvas"></canvas>
                <div id="canvas-info">
                    <p>üëÜ Load a background or start placing assets</p>
                    <p style="font-size: 12px; margin-top: 8px;">
                        <strong>Controls:</strong><br>
                        ‚Ä¢ Click object to select<br>
                        ‚Ä¢ Drag to move<br>
                        ‚Ä¢ Arrow keys to nudge (Shift = 10px)<br>
                        ‚Ä¢ Delete/Backspace to remove
                    </p>
                </div>
            </div>

            <!-- Right Panel: Properties -->
            <div id="properties-panel">
                <h3>Properties</h3>
                <div id="properties-content">
                    <p style="color: #999;">Select an object to view properties</p>
                </div>
            </div>

            <!-- AI Assistant Panel -->
            <aside id="ai-panel" class="ai-panel">
                <!-- Resize Handle -->
                <div class="ai-resize-handle" id="ai-resize-handle" title="Drag to resize panel">
                    <div class="resize-indicator"></div>
                </div>
                
                <div class="ai-header">
                    <div class="ai-title">
                        <img src="./consortium-logo.png" alt="The Consortium" class="ai-logo" onerror="this.style.display='none'">
                        <h3>The Consortium</h3>
                        <div class="ai-persona-badge" id="ai-persona-badge" style="display: none;">
                            <span class="persona-icon">üë§</span>
                            <span class="persona-name" id="active-persona-name">Default</span>
                        </div>
                        <span class="ai-status" id="ai-status">Not Configured</span>
                    </div>
                    <div class="ai-persona-switcher" id="ai-persona-switcher" style="display: none;">
                        <select id="quick-persona-switch" title="Switch AI persona instantly">
                            <optgroup label="‚îÅ‚îÅ‚îÅ GENERAL ‚îÅ‚îÅ‚îÅ">
                                <option value="default" selected>üë§ Default Assistant</option>
                                <option value="fellowship">‚öîÔ∏è Fellowship Team</option>
                            </optgroup>
                            <optgroup label="‚îÅ‚îÅ‚îÅ CORE COUNCIL (Daily Use) ‚îÅ‚îÅ‚îÅ">
                                <option value="master-teacher">üéì Dr. Sarah (Pedagogy)</option>
                                <option value="technical-architect">üíª Alex (Tech Stack)</option>
                                <option value="strategist">üìä Marcus (Strategy)</option>
                                <option value="theologian">‚úùÔ∏è Pastor Jonathan (Theology)</option>
                                <option value="writer">‚úçÔ∏è Emma (Content)</option>
                                <option value="analyst">üìà Dr. Priya (Analytics)</option>
                                <option value="debugger">üîß Max (Debugging)</option>
                            </optgroup>
                            <optgroup label="‚îÅ‚îÅ‚îÅ SPECIALISTS (As Needed) ‚îÅ‚îÅ‚îÅ">
                                <option value="classical-educator">üìö Prof. Helena (Classical)</option>
                                <option value="gen-alpha-expert">üéÆ Zara (Gen Alpha)</option>
                                <option value="ux-designer">üé® Riley (UX Design)</option>
                                <option value="marketing-strategist">üì£ David (Marketing)</option>
                                <option value="game-designer">üïπÔ∏è Jordan (Game Design)</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="ai-model-switcher" id="ai-model-switcher" style="display: none;">
                        <select id="quick-model-switch" title="Switch AI model">
                            <optgroup label="Anthropic">
                                <option value="anthropic:claude-sonnet-4-5">Sonnet 4.5</option>
                                <option value="anthropic:claude-opus-4-5">Opus 4.5</option>
                                <option value="anthropic:claude-haiku-4-5">Haiku 4.5</option>
                                <option value="anthropic:claude-3-5-sonnet-20240620">3.5 Sonnet</option>
                                <option value="anthropic:claude-3-haiku-20240307">3 Haiku</option>
                            </optgroup>
                            <optgroup label="OpenAI">
                                <option value="openai:gpt-5.2">GPT-5.2</option>
                                <option value="openai:gpt-5">GPT-5</option>
                                <option value="openai:gpt-5-mini">GPT-5 Mini</option>
                                <option value="openai:gpt-4.1">GPT-4.1</option>
                                <option value="openai:gpt-3.5-turbo">GPT-3.5</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="ai-actions">
                        <button id="view-memory" class="icon-btn" title="View agent memory">üß†</button>
                        <button id="ai-checkpoint" class="icon-btn" title="Save checkpoint">üíæ</button>
                        <button id="ai-restore" class="icon-btn" title="Restore checkpoint" style="display: none;">‚Ü©Ô∏è</button>
                        <button id="ai-settings" class="icon-btn" title="Configure AI settings">‚öôÔ∏è</button>
                        <button id="show-multi-agent" class="icon-btn" title="Show multi-agent consortium">ü§ñ</button>
                        <button id="ai-clear" class="icon-btn" title="Clear conversation">üóëÔ∏è</button>
                        <button id="ai-toggle" class="icon-btn" title="Close AI panel">√ó</button>
                    </div>
                </div>
                
                <div class="ai-messages" id="ai-messages">
                    <div class="ai-message system">
                        <p><strong>üëã Welcome to AI-Powered Level Design!</strong></p>
                        <p>I'm your collaborative AI assistant. I can:</p>
                        <ul>
                            <li>Answer questions about game design</li>
                            <li>Analyze your level layout</li>
                            <li><strong>Actually manipulate objects</strong> in your level</li>
                            <li>Suggest improvements and implement them</li>
                        </ul>
                        <p style="margin-top: 12px;">Click the ‚öôÔ∏è settings button to configure your API key and get started!</p>
                    </div>
                </div>
                
                <div class="ai-input-container">
                    <textarea 
                        id="ai-input" 
                        placeholder="Ask about your level or request changes... (Enter to send, Shift+Enter for new line)" 
                        rows="3"
                        disabled
                        title="Configure API key in settings to enable AI chat"></textarea>
                    <div class="ai-input-actions">
                        <div class="keyboard-hints" style="display: none;" id="keyboard-hints">
                            <span class="hint"><kbd>‚Üµ</kbd> Send</span>
                            <span class="hint"><kbd>Shift</kbd>+<kbd>‚Üµ</kbd> New line</span>
                            <span class="hint"><kbd>Ctrl</kbd>+<kbd>K</kbd> Clear</span>
                        </div>
                        <button id="ai-send" class="btn-primary" disabled title="Send message (Enter)">
                            <span class="icon">‚û§</span> Send
                        </button>
                    </div>
                </div>

                <!-- Multi-Agent Consortium Interface (Sprint 4) -->
                <div id="multi-agent-section" style="display: none; border-top: 1px solid #3c3c3c; padding-top: 20px; margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; font-size: 14px; color: #cccccc; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">
                            ü§ñ Multi-Agent Consortium
                        </h3>
                        <button id="toggle-multi-agent" class="icon-btn" title="Hide multi-agent interface" style="padding: 4px 8px; font-size: 12px;">Hide</button>
                    </div>

                    <!-- Mode Selector -->
                    <div class="multi-agent-mode-selector">
                        <button class="mode-btn" data-mode="panel" title="Sequential responses from selected personas">
                            üìã Panel Discussion
                        </button>
                        <button class="mode-btn" data-mode="consensus" title="Parallel analysis with majority voting">
                            üó≥Ô∏è Consensus Voting
                        </button>
                        <button class="mode-btn" data-mode="debate" title="Alternating perspectives and counter-arguments">
                            üí¨ Debate
                        </button>
                    </div>

                    <!-- Persona Selector -->
                    <div class="multi-agent-persona-selector">
                        <h3>Select Expert Personas</h3>
                        <div class="persona-categories">
                            <div class="category">
                                <h4>Core Council</h4>
                                <div class="persona-list">
                                    <label><input type="checkbox" name="persona" value="master-teacher"> üë®‚Äçüè´ Master Teacher</label>
                                    <label><input type="checkbox" name="persona" value="strategist"> üìä Strategist</label>
                                    <label><input type="checkbox" name="persona" value="theologian"> ‚õ™ Theologian</label>
                                    <label><input type="checkbox" name="persona" value="classical-educator"> üìñ Classical Educator</label>
                                </div>
                            </div>
                            <div class="category">
                                <h4>Specialists</h4>
                                <div class="persona-list">
                                    <label><input type="checkbox" name="persona" value="technical-architect"> üèóÔ∏è Technical Architect</label>
                                    <label><input type="checkbox" name="persona" value="writer"> ‚úçÔ∏è Writer</label>
                                    <label><input type="checkbox" name="persona" value="analyst"> üî¨ Analyst</label>
                                    <label><input type="checkbox" name="persona" value="debugger"> üêõ Debugger</label>
                                    <label><input type="checkbox" name="persona" value="gen-alpha-expert"> üéÆ Gen-Alpha Expert</label>
                                    <label><input type="checkbox" name="persona" value="ux-designer"> üé® UX Designer</label>
                                    <label><input type="checkbox" name="persona" value="marketing-strategist"> üì¢ Marketing Strategist</label>
                                    <label><input type="checkbox" name="persona" value="game-designer"> üéØ Game Designer</label>
                                </div>
                            </div>
                        </div>
                        <div class="persona-count">None selected (auto-select all)</div>
                        <div class="persona-buttons">
                            <button id="persona-select-all" class="persona-select-all btn-secondary">‚úì Select All</button>
                            <button id="persona-clear-all" class="persona-clear-all btn-secondary">‚úó Clear All</button>
                        </div>
                    </div>

                    <!-- Question Input Area -->
                    <div class="multi-agent-input-area">
                        <textarea 
                            class="question-input" 
                            placeholder="Ask the Consortium a game design question... (Shift+Enter for new line, Enter to execute)"
                            rows="3"
                        ></textarea>
                        <div class="input-controls">
                            <span class="char-count">0 / 2000</span>
                            <button id="execute-workflow" class="execute-btn">‚ñ∂Ô∏è Execute Workflow</button>
                        </div>
                    </div>

                    <!-- Results Display -->
                    <div class="multi-agent-results">
                        <p style="text-align: center; color: #888; padding: 20px;">
                            Results will appear here after executing a workflow
                        </p>
                    </div>
                </div>
            </aside>
            
            <!-- AI Panel Reopen Button (shown when collapsed) -->
            <button id="ai-reopen" class="ai-reopen-btn" style="display: none;" title="Open The Consortium">
                <img src="./consortium-logo.png" alt="The Consortium" class="reopen-logo" onerror="this.style.display='none'">
            </button>
        </div>

        <!-- Status Bar -->
        <div id="status-bar">
            <span id="status-text">‚ú® Ready to create! Load a background or add an asset to begin.</span>
            <span id="mouse-coords">X: 0, Y: 0</span>
            <span id="object-count">Objects: 0</span>
        </div>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="background-input" accept="image/*" style="display: none;">
    <input type="file" id="asset-input" accept="image/*" multiple style="display: none;">
    <input type="file" id="project-input" accept=".json" style="display: none;">

    <!-- AI Settings Modal -->
    <div id="ai-settings-modal" class="modal hidden">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è AI Assistant Preferences</h2>
                <button class="modal-close" id="close-ai-settings">√ó</button>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label for="ai-provider">AI Provider</label>
                    <select id="ai-provider">
                        <option value="anthropic">Anthropic (Claude)</option>
                        <option value="openai">OpenAI (GPT)</option>
                    </select>
                    <small>Choose your preferred AI provider</small>
                </div>

                <div class="form-group">
                    <label for="ai-persona">AI Persona</label>
                    <select id="ai-persona">
                        <optgroup label="General">
                            <option value="default" selected>Default (Conversational Assistant)</option>
                            <option value="fellowship">The Fellowship (Multi-Character Team)</option>
                        </optgroup>
                        <optgroup label="Core Council">
                            <option value="master-teacher">Dr. Sarah Bennett (Master Teacher)</option>
                            <option value="technical-architect">Alex Chen (Technical Architect)</option>
                            <option value="strategist">Marcus Sterling (Business Strategist)</option>
                            <option value="theologian">Pastor Jonathan Edwards (Theologian)</option>
                            <option value="writer">Emma Wordsmith (Content Writer)</option>
                            <option value="analyst">Dr. Priya Patel (Data Analyst)</option>
                            <option value="debugger">Max Troubleshooter (Problem Solver)</option>
                        </optgroup>
                        <optgroup label="Specialty Consultants">
                            <option value="classical-educator">Prof. Helena Classics (Classical Education)</option>
                            <option value="gen-alpha-expert">Zara Chen (Gen Alpha Expert)</option>
                            <option value="ux-designer">Riley Cooper (UX Designer)</option>
                            <option value="marketing-strategist">David Foster (Marketing Strategist)</option>
                            <option value="game-designer">Jordan Kim (Game Designer)</option>
                        </optgroup>
                    </select>
                    <small>Scott's Personal Agent Council - 12 deeply-researched expert personas</small>
                </div>

                <div class="form-group">
                    <label>üß† Agent Memory</label>
                    <div class="memory-stats" id="memory-stats" style="background: #2a2a2a; padding: 12px; border-radius: 4px; margin: 8px 0;">
                        <p style="margin: 4px 0; font-size: 0.9em;"><strong>Conversations:</strong> <span id="memory-count">0</span></p>
                        <p style="margin: 4px 0; font-size: 0.9em;"><strong>Topics:</strong> <span id="memory-topics">None</span></p>
                        <p style="margin: 4px 0; font-size: 0.9em;"><strong>Since:</strong> <span id="memory-since">Never</span></p>
                    </div>
                    <div class="button-group" style="display: flex; gap: 8px; margin-top: 8px;">
                        <button id="view-memory" class="btn-secondary" style="flex: 1;">üëÅÔ∏è View Memory</button>
                        <button id="clear-memory" class="btn-secondary" style="flex: 1; background: #f44336;">üóëÔ∏è Clear</button>
                    </div>
                </div>

                <div class="form-group" id="anthropic-models">
                    <label for="anthropic-model">Claude Model</label>
                    <select id="anthropic-model">
                        <option value="claude-sonnet-4-5" selected>Claude Sonnet 4.5 (Smart for Agents/Coding)</option>
                        <option value="claude-opus-4-5">Claude Opus 4.5 (Maximum Intelligence)</option>
                        <option value="claude-haiku-4-5">Claude Haiku 4.5 (Fastest)</option>
                        <option value="claude-3-5-sonnet-20240620">Claude 3.5 Sonnet (Legacy)</option>
                        <option value="claude-3-haiku-20240307">Claude 3 Haiku (Cheapest)</option>
                    </select>
                    <small>Claude 4.5 models recommended for best performance</small>
                </div>

                <div class="form-group hidden" id="openai-models">
                    <label for="openai-model">GPT Model</label>
                    <select id="openai-model">
                        <option value="gpt-5.2" selected>GPT-5.2 (Best for Coding/Agents)</option>
                        <option value="gpt-5">GPT-5 (Reasoning Model)</option>
                        <option value="gpt-5-mini">GPT-5 Mini (Faster/Cheaper)</option>
                        <option value="gpt-4.1">GPT-4.1 (Smart Non-Reasoning)</option>
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Legacy/Cheapest)</option>
                    </select>
                    <small>GPT-5.2 recommended for game design tasks</small>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="ai-auto-analyze">
                        Enable proactive AI suggestions
                    </label>
                    <small>AI will automatically analyze changes and offer helpful suggestions</small>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="ai-enable-images" checked>
                        Enable inline image generation
                    </label>
                    <small>AI can generate images for sprites, backgrounds, and assets</small>
                </div>
                
                <div class="info-box">
                    <strong>ü§ñ AI Features:</strong>
                    <ul style="margin: 8px 0 0 20px; font-size: 12px;">
                        <li>Game design consultation</li>
                        <li>Level layout analysis</li>
                        <li>Image generation (sprites, backgrounds)</li>
                        <li>Asset recommendations</li>
                    </ul>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn-secondary" id="cancel-ai-settings">Cancel</button>
                <button class="btn-primary" id="save-ai-settings">Save Preferences</button>
            </div>
        </div>
    </div>

    <!-- Memory Viewer Modal -->
    <div id="memory-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px; max-height: 80vh; overflow-y: auto;">
            <h2 style="margin-bottom: 20px;">üß† Agent Memory - <span id="memory-persona-name" style="color: #4CAF50;"></span></h2>
            
            <div class="memory-section" style="margin: 20px 0;">
                <h3 style="border-bottom: 2px solid #444; padding-bottom: 8px;">Recent Conversations</h3>
                <div id="memory-short-term" class="memory-list" style="max-height: 300px; overflow-y: auto; background: #2a2a2a; padding: 12px; border-radius: 4px; margin-top: 12px;"></div>
            </div>
            
            <div class="memory-section" style="margin: 20px 0;">
                <h3 style="border-bottom: 2px solid #444; padding-bottom: 8px;">What I Know About You</h3>
                <div id="memory-long-term" style="background: #2a2a2a; padding: 12px; border-radius: 4px; margin-top: 12px;">
                    <h4 style="color: #4CAF50; margin-top: 12px;">Preferences</h4>
                    <ul id="memory-profile" style="list-style: none; padding-left: 0;"></ul>
                    
                    <h4 style="color: #4CAF50; margin-top: 12px;">Your Project</h4>
                    <ul id="memory-project" style="list-style: none; padding-left: 0;"></ul>
                    
                    <h4 style="color: #4CAF50; margin-top: 12px;">Top Topics Discussed</h4>
                    <ul id="memory-topics-list" style="list-style: none; padding-left: 0;"></ul>
                </div>
            </div>
            
            <div class="modal-actions" style="margin-top: 20px; display: flex; gap: 12px; justify-content: flex-end;">
                <button id="export-memory" class="btn-secondary">üì• Export JSON</button>
                <button id="close-memory-modal" class="btn-primary">Close</button>
            </div>
        </div>
    </div>

    <!-- Agent Memory Module (loaded as module for ES6 compatibility) -->
    <script type="module">
        import { AgentMemory } from './agent-memory.js';
        window.AgentMemory = AgentMemory;
    </script>
    
    <script src="editor.js"></script>
    <script type="module" src="multi-agent-ui.js"></script>
    
    <!-- Fallback initialization for multi-agent UI -->
    <script>
        // Log that script is running
        console.log('%c[INIT] Fallback initialization script running', 'color: #00FF00; font-weight: bold');
        
        // Wait for DOM and module to load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('%c[INIT] DOM Content Loaded', 'color: #0088FF; font-weight: bold');
            
            // Check if controller was initialized
            setTimeout(() => {
                if (window.multiAgentUI) {
                    console.log('%c[SUCCESS] MultiAgentUI controller found and active', 'color: #00FF00; font-weight: bold');
                } else {
                    console.log('%c[WARNING] MultiAgentUI controller not found - attempting manual initialization', 'color: #FFAA00; font-weight: bold');
                    
                    // Manual setup as fallback
                    const showBtn = document.getElementById('show-multi-agent');
                    const section = document.getElementById('multi-agent-section');
                    const hideBtn = document.getElementById('toggle-multi-agent');
                    
                    console.log('%c[DEBUG] Manual setup - checking elements:', 'color: #888888');
                    console.log('  Show button:', showBtn ? '‚úì found' : '‚úó NOT FOUND');
                    console.log('  Section:', section ? '‚úì found' : '‚úó NOT FOUND');
                    console.log('  Hide button:', hideBtn ? '‚úì found' : '‚úó NOT FOUND');
                    
                    if (showBtn && section) {
                        showBtn.addEventListener('click', (e) => {
                            console.log('%c[CLICK] ü§ñ Robot button clicked!', 'color: #0088FF; font-weight: bold');
                            section.style.display = 'block';
                            console.log('%c[SUCCESS] Multi-agent section shown', 'color: #00FF00; font-weight: bold');
                        });
                        console.log('%c[SUCCESS] Manual listener attached to show button', 'color: #00FF00; font-weight: bold');
                    }
                    
                    if (hideBtn && section) {
                        hideBtn.addEventListener('click', (e) => {
                            console.log('%c[CLICK] Hide button clicked!', 'color: #0088FF; font-weight: bold');
                            section.style.display = 'none';
                            console.log('%c[SUCCESS] Multi-agent section hidden', 'color: #00FF00; font-weight: bold');
                        });
                        console.log('%c[SUCCESS] Manual listener attached to hide button', 'color: #00FF00; font-weight: bold');
                    }
                    
                    // Fallback for Select All button
                    const selectAllBtn = document.querySelector('.persona-select-all');
                    if (selectAllBtn) {
                        selectAllBtn.addEventListener('click', (e) => {
                            console.log('%c[FALLBACK] Select All button clicked!', 'color: #0088FF; font-weight: bold');
                            const checkboxes = document.querySelectorAll('input[type="checkbox"][name="persona"]');
                            console.log(`  Found ${checkboxes.length} persona checkboxes`);
                            checkboxes.forEach((cb, i) => {
                                cb.checked = true;
                                console.log(`  ‚úì Checked: ${cb.value}`);
                            });
                            console.log('%c[SUCCESS] All personas selected', 'color: #00FF00; font-weight: bold');
                        });
                        console.log('%c[SUCCESS] Manual listener attached to Select All button', 'color: #00FF00; font-weight: bold');
                    }
                    
                    // Fallback for Clear All button
                    const clearAllBtn = document.querySelector('.persona-clear-all');
                    if (clearAllBtn) {
                        clearAllBtn.addEventListener('click', (e) => {
                            console.log('%c[FALLBACK] Clear All button clicked!', 'color: #0088FF; font-weight: bold');
                            const checkboxes = document.querySelectorAll('input[type="checkbox"][name="persona"]');
                            console.log(`  Found ${checkboxes.length} persona checkboxes`);
                            checkboxes.forEach((cb, i) => {
                                cb.checked = false;
                                console.log(`  ‚úó Unchecked: ${cb.value}`);
                            });
                            console.log('%c[SUCCESS] All personas cleared', 'color: #00FF00; font-weight: bold');
                        });
                        console.log('%c[SUCCESS] Manual listener attached to Clear All button', 'color: #00FF00; font-weight: bold');
                    }
                    
                    // Fallback for Execute Workflow button
                    const executeBtn = document.querySelector('#execute-workflow');
                    if (executeBtn) {
                        executeBtn.addEventListener('click', async (e) => {
                            console.log('%c[FALLBACK] Execute Workflow button clicked!', 'color: #0088FF; font-weight: bold');
                            
                            const questionInput = document.querySelector('.question-input');
                            const question = questionInput?.value?.trim();
                            console.log(`  Question: "${question || '[empty]'}"`);
                            
                            if (!question) {
                                console.log('%c[ERROR] No question entered!', 'color: #FF0000; font-weight: bold');
                                alert('Please enter a question');
                                return;
                            }
                            
                            const checkboxes = document.querySelectorAll('input[type="checkbox"][name="persona"]:checked');
                            const personas = Array.from(checkboxes).map(cb => cb.value);
                            console.log(`  Selected personas: ${personas.length}`);
                            
                            if (personas.length === 0) {
                                console.log('%c[WARNING] No personas selected, auto-selecting all', 'color: #FFAA00; font-weight: bold');
                                Array.from(document.querySelectorAll('input[type="checkbox"][name="persona"]')).forEach(cb => cb.checked = true);
                                personas.push(...Array.from(document.querySelectorAll('input[type="checkbox"][name="persona"]')).map(cb => cb.value));
                            }
                            
                            const modeButtons = document.querySelectorAll('.mode-btn.active');
                            const mode = modeButtons[0]?.dataset?.mode || 'panel';
                            console.log(`  Mode: ${mode}`);
                            
                            // Show loading state
                            executeBtn.disabled = true;
                            executeBtn.textContent = '‚è≥ Executing...';
                            const resultsDiv = document.getElementById('multi-agent-results');
                            if (resultsDiv) resultsDiv.innerHTML = '<p>Loading...</p>';
                            
                            try {
                                console.log('%c[API] Sending request to /api/multi-agent', 'color: #00FF00; font-weight: bold');
                                const response = await fetch('/api/multi-agent', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ question, mode, personas })
                                });
                                
                                if (!response.ok) {
                                    throw new Error(`API returned ${response.status}: ${response.statusText}`);
                                }
                                
                                const result = await response.json();
                                console.log('%c[SUCCESS] API response received', 'color: #00FF00; font-weight: bold', result);
                                
                                // Display results
                                if (resultsDiv) {
                                    resultsDiv.innerHTML = `
                                        <div class="synthesis"><strong>Synthesis:</strong> ${result.synthesis || 'No synthesis'}</div>
                                        <div class="responses" style="margin-top: 20px;">
                                            ${(result.responses || []).map(r => `
                                                <div class="response-card" style="margin: 10px 0; padding: 10px; background: #2a2a2a; border-left: 3px solid #007acc;">
                                                    <strong>${r.persona}:</strong> ${r.response}
                                                </div>
                                            `).join('')}
                                        </div>
                                    `;
                                }
                            } catch (error) {
                                console.error('%c[ERROR] Workflow execution failed', 'color: #FF0000; font-weight: bold', error);
                                if (resultsDiv) resultsDiv.innerHTML = `<p style="color: #FF0000;"><strong>Error:</strong> ${error.message}</p>`;
                            } finally {
                                executeBtn.disabled = false;
                                executeBtn.textContent = '‚ñ∂Ô∏è Execute Workflow';
                            }
                        });
                        console.log('%c[SUCCESS] Manual listener attached to Execute Workflow button', 'color: #00FF00; font-weight: bold');
                    }
                    // Fallback for Mode buttons
                    const modeBtns = document.querySelectorAll('.mode-btn');
                    console.log(`%c[FALLBACK] Found ${modeBtns.length} mode buttons`, 'color: #0088FF; font-weight: bold');
                    
                    // Set first mode as default active
                    if (modeBtns.length > 0) {
                        modeBtns[0].classList.add('active');
                        console.log(`  ‚úì Set first mode (${modeBtns[0].dataset.mode}) as active`);
                    }
                    
                    modeBtns.forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            console.log(`%c[FALLBACK] Mode button clicked: ${btn.dataset.mode}`, 'color: #0088FF; font-weight: bold');
                            
                            // Remove active from all
                            modeBtns.forEach(b => b.classList.remove('active'));
                            // Add active to clicked
                            btn.classList.add('active');
                            
                            console.log(`  ‚úì Mode changed to: ${btn.dataset.mode}`);
                            console.log(`%c[SUCCESS] Mode button updated`, 'color: #00FF00; font-weight: bold');
                        });
                    });
                    console.log('%c[SUCCESS] Manual listeners attached to all mode buttons', 'color: #00FF00; font-weight: bold');
                    
                }
            }, 500);
        });
    </script>
</body>
</html>
