<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Game Level Editor</title>
    <link rel="stylesheet" href="style.css">
    <script src="tooltip.js"></script>
</head>
<body>
    <div id="app">
        <!-- Top Toolbar -->
        <div id="toolbar">
            <h1>ğŸ® Game Level Editor</h1>
            <div class="toolbar-buttons">
                <button id="load-background" title="Load background image (Ctrl+B)">ğŸ“· Load Background</button>
                <button id="add-asset" title="Add sprite/asset (Ctrl+A)">â• Add Asset</button>
                <button id="export-json" title="Export to JSON (Ctrl+E)">ğŸ’¾ Export JSON</button>
                <button id="save-project" title="Save project file (Ctrl+S)">ğŸ“ Save Project</button>
                <button id="load-project" title="Load project file (Ctrl+O)">ğŸ“‚ Load Project</button>
                <button id="clear-all" title="Clear everything">ğŸ—‘ï¸ Clear All</button>
            </div>
        </div>

        <!-- Main Workspace -->
        <div id="workspace">
            <!-- Canvas -->
            <div id="canvas-container">
                <canvas id="canvas"></canvas>
                <div id="canvas-info">
                    <p>ğŸ‘† Load a background or start placing assets</p>
                    <p style="font-size: 12px; margin-top: 8px;">
                        <strong>Controls:</strong><br>
                        â€¢ Click object to select<br>
                        â€¢ Drag to move<br>
                        â€¢ Arrow keys to nudge (Shift = 10px)<br>
                        â€¢ Delete/Backspace to remove
                    </p>
                </div>
            </div>

            <!-- Right Panel: Properties -->
            <div id="properties-panel">
                <h3>Properties</h3>
                <div id="properties-content">
                    <p style="color: #999;">Select an object to view properties</p>
                </div>
            </div>

            <!-- AI Assistant Panel -->
            <aside id="ai-panel" class="ai-panel">
                <!-- Resize Handle -->
                <div class="ai-resize-handle" id="ai-resize-handle" title="Drag to resize panel">
                    <div class="resize-indicator"></div>
                </div>
                
                <div class="ai-header">
                    <div class="ai-title">
                        <img src="./consortium-logo.png" alt="The Consortium" class="ai-logo" onerror="this.style.display='none'">
                        <h3>The Consortium</h3>
                        <div class="ai-persona-badge" id="ai-persona-badge" style="display: none;">
                            <span class="persona-icon">ğŸ‘¤</span>
                            <span class="persona-name" id="active-persona-name">Default</span>
                        </div>
                        <span class="ai-status" id="ai-status">Not Configured</span>
                    </div>
                    <div class="ai-persona-switcher" id="ai-persona-switcher" style="display: none;">
                        <select id="quick-persona-switch" title="Switch AI persona instantly">
                            <optgroup label="â”â”â” GENERAL â”â”â”">
                                <option value="default" selected>ğŸ‘¤ Default Assistant</option>
                                <option value="fellowship">âš”ï¸ Fellowship Team</option>
                            </optgroup>
                            <optgroup label="â”â”â” CORE COUNCIL (Daily Use) â”â”â”">
                                <option value="master-teacher">ğŸ“ Dr. Sarah (Pedagogy)</option>
                                <option value="technical-architect">ğŸ’» Alex (Tech Stack)</option>
                                <option value="strategist">ğŸ“Š Marcus (Strategy)</option>
                                <option value="theologian">âœï¸ Pastor Jonathan (Theology)</option>
                                <option value="writer">âœï¸ Emma (Content)</option>
                                <option value="analyst">ğŸ“ˆ Dr. Priya (Analytics)</option>
                                <option value="debugger">ğŸ”§ Max (Debugging)</option>
                            </optgroup>
                            <optgroup label="â”â”â” SPECIALISTS (As Needed) â”â”â”">
                                <option value="classical-educator">ğŸ“š Prof. Helena (Classical)</option>
                                <option value="gen-alpha-expert">ğŸ® Zara (Gen Alpha)</option>
                                <option value="ux-designer">ğŸ¨ Riley (UX Design)</option>
                                <option value="marketing-strategist">ğŸ“£ David (Marketing)</option>
                                <option value="game-designer">ğŸ•¹ï¸ Jordan (Game Design)</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="ai-model-switcher" id="ai-model-switcher" style="display: none;">
                        <select id="quick-model-switch" title="Switch AI model">
                            <optgroup label="Anthropic">
                                <option value="anthropic:claude-sonnet-4-5">Sonnet 4.5</option>
                                <option value="anthropic:claude-opus-4-5">Opus 4.5</option>
                                <option value="anthropic:claude-haiku-4-5">Haiku 4.5</option>
                                <option value="anthropic:claude-3-5-sonnet-20240620">3.5 Sonnet</option>
                                <option value="anthropic:claude-3-haiku-20240307">3 Haiku</option>
                            </optgroup>
                            <optgroup label="OpenAI">
                                <option value="openai:gpt-5.2">GPT-5.2</option>
                                <option value="openai:gpt-5">GPT-5</option>
                                <option value="openai:gpt-5-mini">GPT-5 Mini</option>
                                <option value="openai:gpt-4.1">GPT-4.1</option>
                                <option value="openai:gpt-3.5-turbo">GPT-3.5</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="ai-actions">
                        <button id="view-memory" class="icon-btn" title="View agent memory">ğŸ§ </button>
                        <button id="ai-checkpoint" class="icon-btn" title="Save checkpoint">ğŸ’¾</button>
                        <button id="ai-restore" class="icon-btn" title="Restore checkpoint" style="display: none;">â†©ï¸</button>
                        <button id="ai-settings" class="icon-btn" title="Configure AI settings">âš™ï¸</button>
                        <button id="show-multi-agent" class="icon-btn" title="Show multi-agent consortium">ğŸ¤–</button>
                        <button id="ai-clear" class="icon-btn" title="Clear conversation">ğŸ—‘ï¸</button>
                        <button id="ai-toggle" class="icon-btn" title="Close AI panel">Ã—</button>
                    </div>
                </div>
                
                <div class="ai-messages" id="ai-messages">
                    <div class="ai-message system">
                        <p><strong>ğŸ‘‹ Welcome to AI-Powered Level Design!</strong></p>
                        <p>I'm your collaborative AI assistant. I can:</p>
                        <ul>
                            <li>Answer questions about game design</li>
                            <li>Analyze your level layout</li>
                            <li><strong>Actually manipulate objects</strong> in your level</li>
                            <li>Suggest improvements and implement them</li>
                        </ul>
                        <p style="margin-top: 12px;">Click the âš™ï¸ settings button to configure your API key and get started!</p>
                    </div>
                </div>
                
                <div class="ai-input-container">
                    <textarea 
                        id="ai-input" 
                        placeholder="Ask about your level or request changes... (Enter to send, Shift+Enter for new line)" 
                        rows="3"
                        disabled
                        title="Configure API key in settings to enable AI chat"></textarea>
                    <div class="ai-input-actions">
                        <div class="keyboard-hints" style="display: none;" id="keyboard-hints">
                            <span class="hint"><kbd>â†µ</kbd> Send</span>
                            <span class="hint"><kbd>Shift</kbd>+<kbd>â†µ</kbd> New line</span>
                            <span class="hint"><kbd>Ctrl</kbd>+<kbd>K</kbd> Clear</span>
                        </div>
                        <button id="ai-send" class="btn-primary" disabled title="Send message (Enter)">
                            <span class="icon">â¤</span> Send
                        </button>
                    </div>
                </div>

                <!-- Multi-Agent Consortium Interface (Sprint 4) -->
                <div id="multi-agent-section" style="display: none; border-top: 1px solid #3c3c3c; padding-top: 20px; margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; font-size: 14px; color: #cccccc; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">
                            ğŸ¤– Multi-Agent Consortium
                        </h3>
                        <button id="toggle-multi-agent" class="icon-btn" title="Hide multi-agent interface" style="padding: 4px 8px; font-size: 12px;">Hide</button>
                    </div>

                    <!-- Mode Selector -->
                    <div class="multi-agent-mode-selector">
                        <button class="mode-btn" data-mode="panel" title="Sequential responses from selected personas">
                            ğŸ“‹ Panel Discussion
                        </button>
                        <button class="mode-btn" data-mode="consensus" title="Parallel analysis with majority voting">
                            ğŸ—³ï¸ Consensus Voting
                        </button>
                        <button class="mode-btn" data-mode="debate" title="Alternating perspectives and counter-arguments">
                            ğŸ’¬ Debate
                        </button>
                    </div>

                    <!-- Persona Selector -->
                    <div class="multi-agent-persona-selector">
                        <h3>Select Expert Personas</h3>
                        <div class="persona-categories">
                            <div class="category">
                                <h4>Core Council</h4>
                                <div class="persona-list">
                                    <label><input type="checkbox" name="persona" value="master-teacher"> ğŸ‘¨â€ğŸ« Master Teacher</label>
                                    <label><input type="checkbox" name="persona" value="strategist"> ğŸ“Š Strategist</label>
                                    <label><input type="checkbox" name="persona" value="theologian"> â›ª Theologian</label>
                                    <label><input type="checkbox" name="persona" value="classical-educator"> ğŸ“– Classical Educator</label>
                                </div>
                            </div>
                            <div class="category">
                                <h4>Specialists</h4>
                                <div class="persona-list">
                                    <label><input type="checkbox" name="persona" value="technical-architect"> ğŸ—ï¸ Technical Architect</label>
                                    <label><input type="checkbox" name="persona" value="writer"> âœï¸ Writer</label>
                                    <label><input type="checkbox" name="persona" value="analyst"> ğŸ”¬ Analyst</label>
                                    <label><input type="checkbox" name="persona" value="debugger"> ğŸ› Debugger</label>
                                    <label><input type="checkbox" name="persona" value="gen-alpha-expert"> ğŸ® Gen-Alpha Expert</label>
                                    <label><input type="checkbox" name="persona" value="ux-designer"> ğŸ¨ UX Designer</label>
                                    <label><input type="checkbox" name="persona" value="marketing-strategist"> ğŸ“¢ Marketing Strategist</label>
                                    <label><input type="checkbox" name="persona" value="game-designer"> ğŸ¯ Game Designer</label>
                                </div>
                            </div>
                        </div>
                        <div class="persona-count">None selected (auto-select all)</div>
                        <div class="persona-buttons">
                            <button id="persona-select-all" class="persona-select-all btn-secondary">âœ“ Select All</button>
                            <button id="persona-clear-all" class="persona-clear-all btn-secondary">âœ— Clear All</button>
                        </div>
                    </div>

                    <!-- Question Input Area -->
                    <div class="multi-agent-input-area">
                        <textarea 
                            class="question-input" 
                            placeholder="Ask the Consortium a game design question... (Shift+Enter for new line, Enter to execute)"
                            rows="3"
                        ></textarea>
                        <div class="input-controls">
                            <span class="char-count">0 / 2000</span>
                            <button id="execute-workflow" class="execute-btn">â–¶ï¸ Execute Workflow</button>
                        </div>
                    </div>

                    <!-- Results Display -->
                    <div class="multi-agent-results">
                        <p style="text-align: center; color: #888; padding: 20px;">
                            Results will appear here after executing a workflow
                        </p>
                    </div>
                </div>
            </aside>
            
            <!-- AI Panel Reopen Button (shown when collapsed) -->
            <button id="ai-reopen" class="ai-reopen-btn" style="display: none;" title="Open The Consortium">
                <img src="./consortium-logo.png" alt="The Consortium" class="reopen-logo" onerror="this.style.display='none'">
            </button>
        </div>

        <!-- Status Bar -->
        <div id="status-bar">
            <span id="status-text">âœ¨ Ready to create! Load a background or add an asset to begin.</span>
            <span id="mouse-coords">X: 0, Y: 0</span>
            <span id="object-count">Objects: 0</span>
        </div>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="background-input" accept="image/*" style="display: none;">
    <input type="file" id="asset-input" accept="image/*" multiple style="display: none;">
    <input type="file" id="project-input" accept=".json" style="display: none;">

    <!-- AI Settings Modal -->
    <div id="ai-settings-modal" class="modal hidden">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>âš™ï¸ AI Assistant Preferences</h2>
                <button class="modal-close" id="close-ai-settings">Ã—</button>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label for="ai-provider">AI Provider</label>
                    <select id="ai-provider">
                        <option value="anthropic">Anthropic (Claude)</option>
                        <option value="openai">OpenAI (GPT)</option>
                    </select>
                    <small>Choose your preferred AI provider</small>
                </div>

                <div class="form-group">
                    <label for="ai-persona">AI Persona</label>
                    <select id="ai-persona">
                        <optgroup label="General">
                            <option value="default" selected>Default (Conversational Assistant)</option>
                            <option value="fellowship">The Fellowship (Multi-Character Team)</option>
                        </optgroup>
                        <optgroup label="Core Council">
                            <option value="master-teacher">Dr. Sarah Bennett (Master Teacher)</option>
                            <option value="technical-architect">Alex Chen (Technical Architect)</option>
                            <option value="strategist">Marcus Sterling (Business Strategist)</option>
                            <option value="theologian">Pastor Jonathan Edwards (Theologian)</option>
                            <option value="writer">Emma Wordsmith (Content Writer)</option>
                            <option value="analyst">Dr. Priya Patel (Data Analyst)</option>
                            <option value="debugger">Max Troubleshooter (Problem Solver)</option>
                        </optgroup>
                        <optgroup label="Specialty Consultants">
                            <option value="classical-educator">Prof. Helena Classics (Classical Education)</option>
                            <option value="gen-alpha-expert">Zara Chen (Gen Alpha Expert)</option>
                            <option value="ux-designer">Riley Cooper (UX Designer)</option>
                            <option value="marketing-strategist">David Foster (Marketing Strategist)</option>
                            <option value="game-designer">Jordan Kim (Game Designer)</option>
                        </optgroup>
                    </select>
                    <small>Scott's Personal Agent Council - 12 deeply-researched expert personas</small>
                </div>

                <div class="form-group">
                    <label>ğŸ§  Agent Memory</label>
                    <div class="memory-stats" id="memory-stats" style="background: #2a2a2a; padding: 12px; border-radius: 4px; margin: 8px 0;">
                        <p style="margin: 4px 0; font-size: 0.9em;"><strong>Conversations:</strong> <span id="memory-count">0</span></p>
                        <p style="margin: 4px 0; font-size: 0.9em;"><strong>Topics:</strong> <span id="memory-topics">None</span></p>
                        <p style="margin: 4px 0; font-size: 0.9em;"><strong>Since:</strong> <span id="memory-since">Never</span></p>
                    </div>
                    <div class="button-group" style="display: flex; gap: 8px; margin-top: 8px;">
                        <button id="view-memory" class="btn-secondary" style="flex: 1;">ğŸ‘ï¸ View Memory</button>
                        <button id="clear-memory" class="btn-secondary" style="flex: 1; background: #f44336;">ğŸ—‘ï¸ Clear</button>
                    </div>
                </div>

                <div class="form-group" id="anthropic-models">
                    <label for="anthropic-model">Claude Model</label>
                    <select id="anthropic-model">
                        <option value="claude-sonnet-4-5" selected>Claude Sonnet 4.5 (Smart for Agents/Coding)</option>
                        <option value="claude-opus-4-5">Claude Opus 4.5 (Maximum Intelligence)</option>
                        <option value="claude-haiku-4-5">Claude Haiku 4.5 (Fastest)</option>
                        <option value="claude-3-5-sonnet-20240620">Claude 3.5 Sonnet (Legacy)</option>
                        <option value="claude-3-haiku-20240307">Claude 3 Haiku (Cheapest)</option>
                    </select>
                    <small>Claude 4.5 models recommended for best performance</small>
                </div>

                <div class="form-group hidden" id="openai-models">
                    <label for="openai-model">GPT Model</label>
                    <select id="openai-model">
                        <option value="gpt-5.2" selected>GPT-5.2 (Best for Coding/Agents)</option>
                        <option value="gpt-5">GPT-5 (Reasoning Model)</option>
                        <option value="gpt-5-mini">GPT-5 Mini (Faster/Cheaper)</option>
                        <option value="gpt-4.1">GPT-4.1 (Smart Non-Reasoning)</option>
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Legacy/Cheapest)</option>
                    </select>
                    <small>GPT-5.2 recommended for game design tasks</small>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="ai-auto-analyze">
                        Enable proactive AI suggestions
                    </label>
                    <small>AI will automatically analyze changes and offer helpful suggestions</small>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="ai-enable-images" checked>
                        Enable inline image generation
                    </label>
                    <small>AI can generate images for sprites, backgrounds, and assets</small>
                </div>
                
                <div class="info-box">
                    <strong>ğŸ¤– AI Features:</strong>
                    <ul style="margin: 8px 0 0 20px; font-size: 12px;">
                        <li>Game design consultation</li>
                        <li>Level layout analysis</li>
                        <li>Image generation (sprites, backgrounds)</li>
                        <li>Asset recommendations</li>
                    </ul>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn-secondary" id="cancel-ai-settings">Cancel</button>
                <button class="btn-primary" id="save-ai-settings">Save Preferences</button>
            </div>
        </div>
    </div>

    <!-- Memory Viewer Modal -->
    <div id="memory-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px; max-height: 80vh; overflow-y: auto;">
            <h2 style="margin-bottom: 20px;">ğŸ§  Agent Memory - <span id="memory-persona-name" style="color: #4CAF50;"></span></h2>
            
            <div class="memory-section" style="margin: 20px 0;">
                <h3 style="border-bottom: 2px solid #444; padding-bottom: 8px;">Recent Conversations</h3>
                <div id="memory-short-term" class="memory-list" style="max-height: 300px; overflow-y: auto; background: #2a2a2a; padding: 12px; border-radius: 4px; margin-top: 12px;"></div>
            </div>
            
            <div class="memory-section" style="margin: 20px 0;">
                <h3 style="border-bottom: 2px solid #444; padding-bottom: 8px;">What I Know About You</h3>
                <div id="memory-long-term" style="background: #2a2a2a; padding: 12px; border-radius: 4px; margin-top: 12px;">
                    <h4 style="color: #4CAF50; margin-top: 12px;">Preferences</h4>
                    <ul id="memory-profile" style="list-style: none; padding-left: 0;"></ul>
                    
                    <h4 style="color: #4CAF50; margin-top: 12px;">Your Project</h4>
                    <ul id="memory-project" style="list-style: none; padding-left: 0;"></ul>
                    
                    <h4 style="color: #4CAF50; margin-top: 12px;">Top Topics Discussed</h4>
                    <ul id="memory-topics-list" style="list-style: none; padding-left: 0;"></ul>
                </div>
            </div>
            
            <div class="modal-actions" style="margin-top: 20px; display: flex; gap: 12px; justify-content: flex-end;">
                <button id="export-memory" class="btn-secondary">ğŸ“¥ Export JSON</button>
                <button id="close-memory-modal" class="btn-primary">Close</button>
            </div>
        </div>
    </div>

    <script src="agent-memory.js"></script>
    <script src="editor.js"></script>
    <script type="module" src="multi-agent-ui.js"></script>
    
    <!-- Fallback initialization for multi-agent UI -->
    <script>
        // Log that script is running
        console.log('%c[INIT] Fallback initialization script running', 'color: #00FF00; font-weight: bold');
        
        // Wait for DOM and module to load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('%c[INIT] DOM Content Loaded', 'color: #0088FF; font-weight: bold');
            
            // Check if controller was initialized
            setTimeout(() => {
                if (window.multiAgentUI) {
                    console.log('%c[SUCCESS] MultiAgentUI controller found and active', 'color: #00FF00; font-weight: bold');
                } else {
                    console.log('%c[WARNING] MultiAgentUI controller not found - attempting manual initialization', 'color: #FFAA00; font-weight: bold');
                    
                    // Manual setup as fallback
                    const showBtn = document.getElementById('show-multi-agent');
                    const section = document.getElementById('multi-agent-section');
                    const hideBtn = document.getElementById('toggle-multi-agent');
                    
                    console.log('%c[DEBUG] Manual setup - checking elements:', 'color: #888888');
                    console.log('  Show button:', showBtn ? 'âœ“ found' : 'âœ— NOT FOUND');
                    console.log('  Section:', section ? 'âœ“ found' : 'âœ— NOT FOUND');
                    console.log('  Hide button:', hideBtn ? 'âœ“ found' : 'âœ— NOT FOUND');
                    
                    if (showBtn && section) {
                        showBtn.addEventListener('click', (e) => {
                            console.log('%c[CLICK] ğŸ¤– Robot button clicked!', 'color: #0088FF; font-weight: bold');
                            section.style.display = 'block';
                            console.log('%c[SUCCESS] Multi-agent section shown', 'color: #00FF00; font-weight: bold');
                        });
                        console.log('%c[SUCCESS] Manual listener attached to show button', 'color: #00FF00; font-weight: bold');
                    }
                    
                    if (hideBtn && section) {
                        hideBtn.addEventListener('click', (e) => {
                            console.log('%c[CLICK] Hide button clicked!', 'color: #0088FF; font-weight: bold');
                            section.style.display = 'none';
                            console.log('%c[SUCCESS] Multi-agent section hidden', 'color: #00FF00; font-weight: bold');
                        });
                        console.log('%c[SUCCESS] Manual listener attached to hide button', 'color: #00FF00; font-weight: bold');
                    }
                    
                    // Fallback for Select All button
                    const selectAllBtn = document.querySelector('.persona-select-all');
                    if (selectAllBtn) {
                        selectAllBtn.addEventListener('click', (e) => {
                            console.log('%c[FALLBACK] Select All button clicked!', 'color: #0088FF; font-weight: bold');
                            const checkboxes = document.querySelectorAll('input[type="checkbox"][name="persona"]');
                            console.log(`  Found ${checkboxes.length} persona checkboxes`);
                            checkboxes.forEach((cb, i) => {
                                cb.checked = true;
                                console.log(`  âœ“ Checked: ${cb.value}`);
                            });
                            console.log('%c[SUCCESS] All personas selected', 'color: #00FF00; font-weight: bold');
                        });
                        console.log('%c[SUCCESS] Manual listener attached to Select All button', 'color: #00FF00; font-weight: bold');
                    }
                    
                    // Fallback for Clear All button
                    const clearAllBtn = document.querySelector('.persona-clear-all');
                    if (clearAllBtn) {
                        clearAllBtn.addEventListener('click', (e) => {
                            console.log('%c[FALLBACK] Clear All button clicked!', 'color: #0088FF; font-weight: bold');
                            const checkboxes = document.querySelectorAll('input[type="checkbox"][name="persona"]');
                            console.log(`  Found ${checkboxes.length} persona checkboxes`);
                            checkboxes.forEach((cb, i) => {
                                cb.checked = false;
                                console.log(`  âœ— Unchecked: ${cb.value}`);
                            });
                            console.log('%c[SUCCESS] All personas cleared', 'color: #00FF00; font-weight: bold');
                        });
                        console.log('%c[SUCCESS] Manual listener attached to Clear All button', 'color: #00FF00; font-weight: bold');
                    }
                }
            }, 500);
        });
    </script>
</body>
</html>
