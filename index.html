<!DOCTYPE html>
<!-- Version: TABLE_SUPPORT_1765950000 - Added Word export table conversion -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Game Level Editor</title>
    
    <!-- Supabase Configuration (frontend-safe anon key with RLS) -->
    <meta name="supabase-url" content="https://kxctrosgcockwtrteizd.supabase.co">
    <meta name="supabase-anon-key" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4Y3Ryb3NnY29ja3d0cnRlaXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3ODA4MzIsImV4cCI6MjA4MTM1NjgzMn0.F9yb5rkd9UMLL3e7fD4xYWEVgIJgVR8HpMDcG84SMPE">
    
    <link rel="stylesheet" href="style.css">
    <script src="tooltip.js"></script>
</head>
<body>
    <div id="app">
        <!-- Top Toolbar -->
        <div id="toolbar">
            <h1>üéÆ Game Level Editor</h1>
            <div class="toolbar-buttons">
                <button id="load-background" title="Load background image (Ctrl+B)">üì∑ Load Background</button>
                <button id="add-asset" title="Add sprite/asset (Ctrl+A)">‚ûï Add Asset</button>
                <button id="export-json" title="Export to JSON (Ctrl+E)">üíæ Export JSON</button>
                <button id="save-project" title="Save project file (Ctrl+S)">üìÅ Save Project</button>
                <button id="load-project" title="Load project file (Ctrl+O)">üìÇ Load Project</button>
                <button id="clear-all" title="Clear everything">üóëÔ∏è Clear All</button>
                
                <!-- Authentication UI -->
                <div id="auth-container" style="margin-left: auto; display: flex; align-items: center; gap: 10px;">
                    <!-- Sync Status Indicator -->
                    <div id="sync-status" style="display: none; font-size: 12px; color: #888;">
                        <span id="sync-icon">üíæ</span>
                        <span id="sync-text">Synced</span>
                    </div>
                    
                    <!-- Sign In Button (shown when not authenticated) -->
                    <button id="sign-in-btn" style="display: none;">
                        üîì Sign In
                    </button>
                    
                    <!-- User Profile (shown when authenticated) -->
                    <div id="user-profile" style="display: none; position: relative;">
                        <button id="profile-btn" style="display: flex; align-items: center; gap: 8px;">
                            <img id="user-avatar" src="" alt="" style="width: 24px; height: 24px; border-radius: 50%;">
                            <span id="user-email"></span>
                            <span>‚ñº</span>
                        </button>
                        
                        <!-- Profile Dropdown -->
                        <div id="profile-dropdown" style="display: none; position: absolute; right: 0; top: 100%; margin-top: 5px; background: #2a2a2a; border: 1px solid #444; border-radius: 4px; padding: 8px; min-width: 200px; z-index: 1000;">
                            <div style="padding: 8px; border-bottom: 1px solid #444; margin-bottom: 8px;">
                                <div style="font-size: 12px; color: #888;">Signed in as</div>
                                <div id="profile-email" style="font-size: 14px; font-weight: bold;"></div>
                            </div>
                            <button id="sign-out-btn" style="width: 100%; text-align: left; padding: 8px; background: none; border: none; color: #ff6b6b; cursor: pointer;">
                                üö™ Sign Out
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Auth Modal (for OAuth providers) -->
        <div id="auth-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center;">
            <div style="background: #1e1e1e; padding: 30px; border-radius: 8px; max-width: 400px; width: 90%;">
                <h2 style="margin-top: 0;">Sign In to Sync</h2>
                <p style="color: #888; font-size: 14px; margin-bottom: 20px;">
                    Sign in to enable cloud sync across all your devices
                </p>
                
                <button id="google-sign-in" style="width: 100%; margin-bottom: 10px; padding: 12px; background: #4285f4; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">
                    <img src="https://www.google.com/favicon.ico" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 8px;">
                    Continue with Google
                </button>
                
                <button id="github-sign-in" style="width: 100%; padding: 12px; background: #333; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">
                    <img src="https://github.com/favicon.ico" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 8px;">
                    Continue with GitHub
                </button>
                
                <button id="cancel-auth" style="width: 100%; margin-top: 15px; padding: 8px; background: none; border: 1px solid #444; border-radius: 4px; cursor: pointer; color: #888;">
                    Cancel
                </button>
            </div>
        </div>

        <!-- Main Workspace -->
        <div id="workspace">
            <!-- Canvas -->
            <div id="canvas-container">
                <canvas id="canvas"></canvas>
                <div id="canvas-info">
                    <p>üëÜ Load a background or start placing assets</p>
                    <p style="font-size: 12px; margin-top: 8px;">
                        <strong>Controls:</strong><br>
                        ‚Ä¢ Click object to select<br>
                        ‚Ä¢ Drag to move<br>
                        ‚Ä¢ Arrow keys to nudge (Shift = 10px)<br>
                        ‚Ä¢ Delete/Backspace to remove
                    </p>
                </div>
            </div>

            <!-- Right Panel: Properties -->
            <div id="properties-panel">
                <h3>Properties</h3>
                <div id="properties-content">
                    <p style="color: #999;">Select an object to view properties</p>
                </div>
            </div>

            <!-- AI Assistant Panel -->
            <aside id="ai-panel" class="ai-panel">
                <!-- Resize Handle -->
                <div class="ai-resize-handle" id="ai-resize-handle" title="Drag to resize panel">
                    <div class="resize-indicator"></div>
                </div>
                
                <div class="ai-header">
                    <div class="ai-title">
                        <img src="./consortium-logo.png" alt="The Consortium" class="ai-logo" onerror="this.style.display='none'">
                        <h3>The Consortium</h3>
                        <div class="ai-persona-badge" id="ai-persona-badge" style="display: none;">
                            <span class="persona-icon">üë§</span>
                            <span class="persona-name" id="active-persona-name">Default</span>
                        </div>
                        <span class="ai-status" id="ai-status">Not Configured</span>
                    </div>
                    <div class="ai-persona-switcher" id="ai-persona-switcher" style="display: none;">
                        <select id="quick-persona-switch" title="Switch AI persona instantly">
                            <optgroup label="‚îÅ‚îÅ‚îÅ GENERAL ‚îÅ‚îÅ‚îÅ">
                                <option value="default" selected>üë§ Default Assistant</option>
                                <option value="fellowship">‚öîÔ∏è Fellowship Team</option>
                            </optgroup>
                            <optgroup label="‚îÅ‚îÅ‚îÅ CORE COUNCIL (Daily Use) ‚îÅ‚îÅ‚îÅ">
                                <option value="master-teacher">üéì Dr. Sarah (Pedagogy)</option>
                                <option value="technical-architect">üíª Alex (Tech Stack)</option>
                                <option value="strategist">üìä Marcus (Strategy)</option>
                                <option value="theologian">‚úùÔ∏è Pastor Jonathan (Theology)</option>
                                <option value="writer">‚úçÔ∏è Emma (Content)</option>
                                <option value="analyst">üìà Dr. Priya (Analytics)</option>
                                <option value="debugger">üîß Max (Debugging)</option>
                            </optgroup>
                            <optgroup label="‚îÅ‚îÅ‚îÅ SPECIALISTS (As Needed) ‚îÅ‚îÅ‚îÅ">
                                <option value="classical-educator">üìö Prof. Helena (Classical)</option>
                                <option value="gen-alpha-expert">üéÆ Zara (Gen Alpha)</option>
                                <option value="ux-designer">üé® Riley (UX Design)</option>
                                <option value="marketing-strategist">üì£ David (Marketing)</option>
                                <option value="game-designer">üïπÔ∏è Jordan (Game Design)</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="ai-model-switcher" id="ai-model-switcher" style="display: none;">
                        <select id="quick-model-switch" title="Switch AI model">
                            <optgroup label="Anthropic">
                                <option value="anthropic:claude-sonnet-4-5">Sonnet 4.5</option>
                                <option value="anthropic:claude-opus-4-5">Opus 4.5</option>
                                <option value="anthropic:claude-haiku-4-5">Haiku 4.5</option>
                                <option value="anthropic:claude-3-5-sonnet-20240620">3.5 Sonnet</option>
                                <option value="anthropic:claude-3-haiku-20240307">3 Haiku</option>
                            </optgroup>
                            <optgroup label="OpenAI">
                                <option value="openai:gpt-5.2">GPT-5.2</option>
                                <option value="openai:gpt-5">GPT-5</option>
                                <option value="openai:gpt-5-mini">GPT-5 Mini</option>
                                <option value="openai:gpt-4.1">GPT-4.1</option>
                                <option value="openai:gpt-3.5-turbo">GPT-3.5</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="ai-actions">
                        <button id="view-memory" class="icon-btn" title="View agent memory">üß†</button>
                        <button id="ai-checkpoint" class="icon-btn" title="Save checkpoint">üíæ</button>
                        <button id="ai-restore" class="icon-btn" title="Restore checkpoint" style="display: none;">‚Ü©Ô∏è</button>
                        <button id="ai-settings" class="icon-btn" title="Configure AI settings">‚öôÔ∏è</button>
                        <button id="show-multi-agent" class="icon-btn" title="Show multi-agent consortium">ü§ñ</button>
                        <button id="ai-clear" class="icon-btn" title="Clear conversation">üóëÔ∏è</button>
                        <button id="ai-toggle" class="icon-btn" title="Close AI panel">√ó</button>
                    </div>
                </div>
                
                <!-- Research Tabs - Phase 8 -->
                <div class="ai-tabs">
                    <button class="ai-tab-btn active" data-tab="chat">üí¨ Chat</button>
                    <button class="ai-tab-btn" data-tab="video">üìπ Video</button>
                </div>
                
                <!-- Chat Tab Content -->
                <div class="ai-tab-content active" id="chat-tab">
                    <div class="ai-messages" id="ai-messages">
                        <div class="ai-message system">
                            <p><strong>üëã Welcome to AI-Powered Level Design!</strong></p>
                            <p>I'm your collaborative AI assistant. I can:</p>
                            <ul>
                                <li>Answer questions about game design</li>
                                <li>Analyze your level layout</li>
                                <li><strong>Actually manipulate objects</strong> in your level</li>
                                <li>Suggest improvements and implement them</li>
                            </ul>
                            <p style="margin-top: 12px;">Click the ‚öôÔ∏è settings button to configure your API key and get started!</p>
                        </div>
                    </div>
                    
                    <div class="ai-input-container">
                        <textarea 
                            id="ai-input" 
                            placeholder="Ask about your level or request changes... (Enter to send, Shift+Enter for new line)" 
                            rows="3"
                            disabled
                            title="Configure API key in settings to enable AI chat"></textarea>
                        <div class="ai-input-actions">
                            <div class="keyboard-hints" style="display: none;" id="keyboard-hints">
                                <span class="hint"><kbd>‚Üµ</kbd> Send</span>
                                <span class="hint"><kbd>Shift</kbd>+<kbd>‚Üµ</kbd> New line</span>
                                <span class="hint"><kbd>Ctrl</kbd>+<kbd>K</kbd> Clear</span>
                            </div>
                            <button id="ai-send" class="btn-primary" disabled title="Send message (Enter)">
                                <span class="icon">‚û§</span> Send
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Video Tab Content - Phase 8 -->
                <div class="ai-tab-content" id="video-tab" style="display: none;">
                    <!-- Video UI will be injected here -->
                </div>
            </aside>
            
            <!-- AI Panel Reopen Button (shown when collapsed) -->
            <button id="ai-reopen" class="ai-reopen-btn" style="display: none;" title="Open The Consortium">
                <img src="./consortium-logo.png" alt="The Consortium" class="reopen-logo" onerror="this.style.display='none'">
            </button>
        </div>

        <!-- Status Bar -->
        <div id="status-bar">
            <span id="status-text">‚ú® Ready to create! Load a background or add an asset to begin.</span>
            <span id="mouse-coords">X: 0, Y: 0</span>
            <span id="object-count">Objects: 0</span>
        </div>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="background-input" accept="image/*" style="display: none;">
    <input type="file" id="asset-input" accept="image/*" multiple style="display: none;">
    <input type="file" id="project-input" accept=".json" style="display: none;">

    <!-- AI Settings Modal -->
    <div id="ai-settings-modal" class="modal hidden">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è AI Assistant Preferences</h2>
                <button class="modal-close" id="close-ai-settings">√ó</button>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label for="ai-provider">AI Provider</label>
                    <select id="ai-provider">
                        <option value="anthropic">Anthropic (Claude)</option>
                        <option value="openai">OpenAI (GPT)</option>
                    </select>
                    <small>Choose your preferred AI provider</small>
                </div>

                <div class="form-group">
                    <label for="ai-persona">AI Persona</label>
                    <select id="ai-persona">
                        <optgroup label="General">
                            <option value="default" selected>Default (Conversational Assistant)</option>
                            <option value="fellowship">The Fellowship (Multi-Character Team)</option>
                        </optgroup>
                        <optgroup label="Core Council">
                            <option value="master-teacher">Dr. Sarah Bennett (Master Teacher)</option>
                            <option value="technical-architect">Alex Chen (Technical Architect)</option>
                            <option value="strategist">Marcus Sterling (Business Strategist)</option>
                            <option value="theologian">Pastor Jonathan Edwards (Theologian)</option>
                            <option value="writer">Emma Wordsmith (Content Writer)</option>
                            <option value="analyst">Dr. Priya Patel (Data Analyst)</option>
                            <option value="debugger">Max Troubleshooter (Problem Solver)</option>
                        </optgroup>
                        <optgroup label="Specialty Consultants">
                            <option value="classical-educator">Prof. Helena Classics (Classical Education)</option>
                            <option value="gen-alpha-expert">Zara Chen (Gen Alpha Expert)</option>
                            <option value="ux-designer">Riley Cooper (UX Designer)</option>
                            <option value="marketing-strategist">David Foster (Marketing Strategist)</option>
                            <option value="game-designer">Jordan Kim (Game Designer)</option>
                        </optgroup>
                    </select>
                    <small>Scott's Personal Agent Council - 12 deeply-researched expert personas</small>
                </div>

                <div class="form-group">
                    <label>üß† Agent Memory</label>
                    <div class="memory-stats" id="memory-stats" style="background: #2a2a2a; padding: 12px; border-radius: 4px; margin: 8px 0;">
                        <p style="margin: 4px 0; font-size: 0.9em;"><strong>Conversations:</strong> <span id="memory-count">0</span></p>
                        <p style="margin: 4px 0; font-size: 0.9em;"><strong>Topics:</strong> <span id="memory-topics">None</span></p>
                        <p style="margin: 4px 0; font-size: 0.9em;"><strong>Since:</strong> <span id="memory-since">Never</span></p>
                    </div>
                    <div class="button-group" style="display: flex; gap: 8px; margin-top: 8px;">
                        <button id="view-memory" class="btn-secondary" style="flex: 1;">üëÅÔ∏è View Memory</button>
                        <button id="clear-memory" class="btn-secondary" style="flex: 1; background: #f44336;">üóëÔ∏è Clear</button>
                    </div>
                </div>

                <div class="form-group" id="anthropic-models">
                    <label for="anthropic-model">Claude Model</label>
                    <select id="anthropic-model">
                        <option value="claude-sonnet-4-5" selected>Claude Sonnet 4.5 (Smart for Agents/Coding)</option>
                        <option value="claude-opus-4-5">Claude Opus 4.5 (Maximum Intelligence)</option>
                        <option value="claude-haiku-4-5">Claude Haiku 4.5 (Fastest)</option>
                        <option value="claude-3-5-sonnet-20240620">Claude 3.5 Sonnet (Legacy)</option>
                        <option value="claude-3-haiku-20240307">Claude 3 Haiku (Cheapest)</option>
                    </select>
                    <small>Claude 4.5 models recommended for best performance</small>
                </div>

                <div class="form-group hidden" id="openai-models">
                    <label for="openai-model">GPT Model</label>
                    <select id="openai-model">
                        <option value="gpt-5.2" selected>GPT-5.2 (Best for Coding/Agents)</option>
                        <option value="gpt-5">GPT-5 (Reasoning Model)</option>
                        <option value="gpt-5-mini">GPT-5 Mini (Faster/Cheaper)</option>
                        <option value="gpt-4.1">GPT-4.1 (Smart Non-Reasoning)</option>
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Legacy/Cheapest)</option>
                    </select>
                    <small>GPT-5.2 recommended for game design tasks</small>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="ai-auto-analyze">
                        Enable proactive AI suggestions
                    </label>
                    <small>AI will automatically analyze changes and offer helpful suggestions</small>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="ai-enable-images" checked>
                        Enable inline image generation
                    </label>
                    <small>AI can generate images for sprites, backgrounds, and assets</small>
                </div>
                
                <div class="info-box">
                    <strong>ü§ñ AI Features:</strong>
                    <ul style="margin: 8px 0 0 20px; font-size: 12px;">
                        <li>Game design consultation</li>
                        <li>Level layout analysis</li>
                        <li>Image generation (sprites, backgrounds)</li>
                        <li>Asset recommendations</li>
                    </ul>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn-secondary" id="cancel-ai-settings">Cancel</button>
                <button class="btn-primary" id="save-ai-settings">Save Preferences</button>
            </div>
        </div>
    </div>

    <!-- Memory Viewer Modal -->
    <div id="memory-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px; max-height: 80vh; overflow-y: auto;">
            <h2 style="margin-bottom: 20px;">üß† Agent Memory - <span id="memory-persona-name" style="color: #4CAF50;"></span></h2>
            
            <div class="memory-section" style="margin: 20px 0;">
                <h3 style="border-bottom: 2px solid #444; padding-bottom: 8px;">Recent Conversations</h3>
                <div id="memory-short-term" class="memory-list" style="max-height: 300px; overflow-y: auto; background: #2a2a2a; padding: 12px; border-radius: 4px; margin-top: 12px;"></div>
            </div>
            
            <div class="memory-section" style="margin: 20px 0;">
                <h3 style="border-bottom: 2px solid #444; padding-bottom: 8px;">What I Know About You</h3>
                <div id="memory-long-term" style="background: #2a2a2a; padding: 12px; border-radius: 4px; margin-top: 12px;">
                    <h4 style="color: #4CAF50; margin-top: 12px;">Preferences</h4>
                    <ul id="memory-profile" style="list-style: none; padding-left: 0;"></ul>
                    
                    <h4 style="color: #4CAF50; margin-top: 12px;">Your Project</h4>
                    <ul id="memory-project" style="list-style: none; padding-left: 0;"></ul>
                    
                    <h4 style="color: #4CAF50; margin-top: 12px;">Top Topics Discussed</h4>
                    <ul id="memory-topics-list" style="list-style: none; padding-left: 0;"></ul>
                </div>
            </div>
            
            <div class="modal-actions" style="margin-top: 20px; display: flex; gap: 12px; justify-content: flex-end;">
                <button id="export-memory" class="btn-secondary">üì• Export JSON</button>
                <button id="close-memory-modal" class="btn-primary">Close</button>
            </div>
        </div>
    </div>

    <!-- Agent Memory Module (loaded as module for ES6 compatibility) -->
    <script type="module">
        import { AgentMemory } from './agent-memory.js';
        window.AgentMemory = AgentMemory;
    </script>
    
    <script src="editor.js"></script>
    <script type="module" src="multi-agent-ui.js"></script>
    
    <!-- Fallback initialization for multi-agent UI -->
    <script>
        // Log that script is running
        console.log('%c[INIT] Fallback initialization script running', 'color: #00FF00; font-weight: bold');
        
        // Wait for DOM and module to load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('%c[INIT] DOM Content Loaded', 'color: #0088FF; font-weight: bold');
            
            // Check if controller was initialized
            setTimeout(() => {
                if (window.multiAgentUI) {
                    console.log('%c[SUCCESS] MultiAgentUI controller found and active', 'color: #00FF00; font-weight: bold');
                } else {
                    console.log('%c[WARNING] MultiAgentUI controller not found - attempting manual initialization', 'color: #FFAA00; font-weight: bold');
                    
                    // Manual setup as fallback - now using modal
                    const showBtn = document.getElementById('show-multi-agent');
                    const modal = document.getElementById('multi-agent-modal');
                    const closeBtn = document.getElementById('modal-close');
                    
                    console.log('%c[DEBUG] Manual setup - checking elements:', 'color: #888888');
                    console.log('  Show button:', showBtn ? '‚úì found' : '‚úó NOT FOUND');
                    console.log('  Modal:', modal ? '‚úì found' : '‚úó NOT FOUND');
                    console.log('  Close button:', closeBtn ? '‚úì found' : '‚úó NOT FOUND');
                    
                    if (showBtn && modal) {
                        showBtn.addEventListener('click', (e) => {
                            console.log('%c[CLICK] ü§ñ Robot button clicked!', 'color: #0088FF; font-weight: bold');
                            modal.style.display = 'flex';
                            console.log('%c[SUCCESS] Modal shown', 'color: #00FF00; font-weight: bold');
                        });
                        console.log('%c[SUCCESS] Manual listener attached to show button', 'color: #00FF00; font-weight: bold');
                    }
                    
                    if (closeBtn && modal) {
                        closeBtn.addEventListener('click', (e) => {
                            console.log('%c[CLICK] Close button clicked!', 'color: #0088FF; font-weight: bold');
                            modal.style.display = 'none';
                            console.log('%c[SUCCESS] Modal hidden', 'color: #00FF00; font-weight: bold');
                        });
                        console.log('%c[SUCCESS] Manual listener attached to close button', 'color: #00FF00; font-weight: bold');
                    }
                    
                    // Click outside modal to close
                    if (modal) {
                        modal.addEventListener('click', (e) => {
                            if (e.target === modal) {
                                modal.style.display = 'none';
                            }
                        });
                    }
                    
                    // Fallback for Select All button
                    const selectAllBtn = document.getElementById('modal-select-all');
                    if (selectAllBtn) {
                        selectAllBtn.addEventListener('click', (e) => {
                            console.log('%c[FALLBACK] Select All button clicked!', 'color: #0088FF; font-weight: bold');
                            const checkboxes = document.querySelectorAll('input[type="checkbox"][name="persona"]');
                            console.log(`  Found ${checkboxes.length} persona checkboxes`);
                            checkboxes.forEach((cb, i) => {
                                cb.checked = true;
                            });
                            console.log('%c[SUCCESS] All personas selected', 'color: #00FF00; font-weight: bold');
                        });
                        console.log('%c[SUCCESS] Manual listener attached to Select All button', 'color: #00FF00; font-weight: bold');
                    }
                    
                    // Fallback for Clear All button
                    const clearAllBtn = document.getElementById('modal-clear-all');
                    if (clearAllBtn) {
                        clearAllBtn.addEventListener('click', (e) => {
                            console.log('%c[FALLBACK] Clear All button clicked!', 'color: #0088FF; font-weight: bold');
                            const checkboxes = document.querySelectorAll('input[type="checkbox"][name="persona"]');
                            console.log(`  Found ${checkboxes.length} persona checkboxes`);
                            checkboxes.forEach((cb, i) => {
                                cb.checked = false;
                            });
                            console.log('%c[SUCCESS] All personas cleared', 'color: #00FF00; font-weight: bold');
                        });
                        console.log('%c[SUCCESS] Manual listener attached to Clear All button', 'color: #00FF00; font-weight: bold');
                    }
                    
                    // Fallback for Execute Workflow button
                    const executeBtn = document.getElementById('modal-execute-workflow');
                    if (executeBtn) {
                        executeBtn.addEventListener('click', async (e) => {
                            console.log('%c[FALLBACK] Execute Workflow button clicked!', 'color: #0088FF; font-weight: bold');
                            
                            const questionInput = document.querySelector('.question-input');
                            const question = questionInput?.value?.trim();
                            console.log(`  Question: "${question || '[empty]'}"`);
                            
                            if (!question) {
                                console.log('%c[ERROR] No question entered!', 'color: #FF0000; font-weight: bold');
                                alert('Please enter a question');
                                return;
                            }
                            
                            const checkboxes = document.querySelectorAll('input[type="checkbox"][name="persona"]:checked');
                            const personas = Array.from(checkboxes).map(cb => cb.value);
                            console.log(`  Selected personas: ${personas.length}`);
                            
                            if (personas.length === 0) {
                                console.log('%c[WARNING] No personas selected, auto-selecting all', 'color: #FFAA00; font-weight: bold');
                                Array.from(document.querySelectorAll('input[type="checkbox"][name="persona"]')).forEach(cb => cb.checked = true);
                                personas.push(...Array.from(document.querySelectorAll('input[type="checkbox"][name="persona"]')).map(cb => cb.value));
                            }
                            
                            const modeButtons = document.querySelectorAll('.mode-btn.active');
                            const mode = modeButtons[0]?.dataset?.mode || 'panel';
                            console.log(`  Mode: ${mode}`);
                            
                            // Show loading state
                            executeBtn.disabled = true;
                            executeBtn.textContent = '‚è≥ Executing...';
                            const resultsDiv = document.querySelector('.multi-agent-results');
                            if (resultsDiv) resultsDiv.innerHTML = '<p>Loading...</p>';
                            
                            try {
                                console.log('%c[API] Sending request to /api/multi-agent', 'color: #00FF00; font-weight: bold');
                                const response = await fetch('/api/multi-agent', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ question, mode, personas })
                                });
                                
                                if (!response.ok) {
                                    throw new Error(`API returned ${response.status}: ${response.statusText}`);
                                }
                                
                                const result = await response.json();
                                console.log('%c[SUCCESS] API response received', 'color: #00FF00; font-weight: bold', result);
                                
                                // Display results
                                if (resultsDiv) {
                                    resultsDiv.innerHTML = `
                                        <div class="synthesis"><strong>Synthesis:</strong> ${result.synthesis || 'No synthesis'}</div>
                                        <div class="responses" style="margin-top: 20px;">
                                            ${(result.responses || []).map(r => `
                                                <div class="response-card" style="margin: 10px 0; padding: 10px; background: #2a2a2a; border-left: 3px solid #007acc;">
                                                    <strong>${r.persona}:</strong> ${r.response}
                                                </div>
                                            `).join('')}
                                        </div>
                                    `;
                                }
                            } catch (error) {
                                console.error('%c[ERROR] Workflow execution failed', 'color: #FF0000; font-weight: bold', error);
                                if (resultsDiv) resultsDiv.innerHTML = `<p style="color: #FF0000;"><strong>Error:</strong> ${error.message}</p>`;
                            } finally {
                                executeBtn.disabled = false;
                                executeBtn.textContent = '‚ñ∂Ô∏è Execute Workflow';
                            }
                        });
                        console.log('%c[SUCCESS] Manual listener attached to Execute Workflow button', 'color: #00FF00; font-weight: bold');
                    }
                    
                    // Fallback for Mode buttons
                    const modeBtns = document.querySelectorAll('.mode-btn');
                    console.log(`%c[FALLBACK] Found ${modeBtns.length} mode buttons`, 'color: #0088FF; font-weight: bold');
                    
                    // Set first mode as default active
                    if (modeBtns.length > 0) {
                        modeBtns[0].classList.add('active');
                        console.log(`  ‚úì Set first mode (${modeBtns[0].dataset.mode}) as active`);
                    }
                    
                    modeBtns.forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            console.log(`%c[FALLBACK] Mode button clicked: ${btn.dataset.mode}`, 'color: #0088FF; font-weight: bold');
                            
                            // Remove active from all
                            modeBtns.forEach(b => b.classList.remove('active'));
                            // Add active to clicked
                            btn.classList.add('active');
                            
                            console.log(`  ‚úì Mode changed to: ${btn.dataset.mode}`);
                            console.log(`%c[SUCCESS] Mode button updated`, 'color: #00FF00; font-weight: bold');
                        });
                    });
                    console.log('%c[SUCCESS] Manual listeners attached to all mode buttons', 'color: #00FF00; font-weight: bold');
                }
            }, 500);
        });
    </script>

    <!-- Multi-Agent Consortium Modal -->
    <!-- Multi-Agent Modal -->
    <div id="multi-agent-modal" class="multi-agent-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ü§ñ The Consortium</h2>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Mode Selector -->
                <div class="multi-agent-mode-selector">
                    <button class="mode-btn" data-mode="panel">üìã Panel Discussion</button>
                    <button class="mode-btn" data-mode="consensus">üó≥Ô∏è Consensus Voting</button>
                    <button class="mode-btn" data-mode="debate">üí¨ Debate</button>
                    <button class="mode-btn" data-mode="conversation" id="conversation-mode-btn">üéôÔ∏è Live Conversation</button>
                    <button class="mode-btn" data-mode="research" id="research-mode-btn">üîç Deep Research</button>
                </div>

                <!-- Split Layout: Left (Input/Selection) and Right (Results) -->
                <div class="modal-split">
                    <!-- Left Panel: Input & Selection -->
                    <div class="modal-left">
                        <!-- Persona Selector -->
                        <div class="multi-agent-persona-selector">
                            <h3>Specialists</h3>
                            <div class="persona-categories">
                                <div class="category">
                                    <h4>Education</h4>
                                    <label><input type="checkbox" name="persona" value="master-teacher"> üë®‚Äçüè´ Master Teacher</label>
                                    <label><input type="checkbox" name="persona" value="classical-educator"> üìñ Classical Educator</label>
                                </div>
                                <div class="category">
                                    <h4>Strategy</h4>
                                    <label><input type="checkbox" name="persona" value="strategist"> üìä Strategist</label>
                                    <label><input type="checkbox" name="persona" value="theologian"> ‚õ™ Theologian</label>
                                </div>
                                <div class="category">
                                    <h4>Technical</h4>
                                    <label><input type="checkbox" name="persona" value="technical-architect"> üèóÔ∏è Technical Architect</label>
                                    <label><input type="checkbox" name="persona" value="debugger"> üêõ Debugger</label>
                                </div>
                                <div class="category">
                                    <h4>Creative</h4>
                                    <label><input type="checkbox" name="persona" value="writer"> ‚úçÔ∏è Writer</label>
                                    <label><input type="checkbox" name="persona" value="ux-designer"> üé® UX Designer</label>
                                </div>
                                <div class="category">
                                    <h4>Analysis</h4>
                                    <label><input type="checkbox" name="persona" value="analyst"> üî¨ Analyst</label>
                                    <label><input type="checkbox" name="persona" value="gen-alpha-expert"> üéÆ Gen-Alpha Expert</label>
                                </div>
                                <div class="category">
                                    <h4>Marketing</h4>
                                    <label><input type="checkbox" name="persona" value="marketing-strategist"> üì¢ Marketing Strategist</label>
                                    <label><input type="checkbox" name="persona" value="game-designer"> üéØ Game Designer</label>
                                </div>
                            </div>
                            <div class="persona-count">None selected</div>
                            <div class="persona-buttons">
                                <button id="modal-select-all" class="persona-select-all btn-secondary">‚úì Select All</button>
                                <button id="modal-clear-all" class="persona-clear-all btn-secondary">‚úó Clear All</button>
                            </div>
                        </div>

                        <!-- Question Input -->
                        <div class="multi-agent-input-area">
                            <textarea 
                                class="question-input" 
                                placeholder="Ask the Consortium a question... (Shift+Enter for new line, Enter to execute)"
                                rows="4"
                            ></textarea>
                            <div class="input-controls">
                                <span class="char-count">0 / 2000</span>
                                <button id="modal-execute-workflow" class="execute-btn">‚ñ∂Ô∏è Execute Workflow</button>
                                <button id="modal-start-conversation" class="execute-btn" style="display:none;">üéôÔ∏è Start Conversation</button>
                            </div>
                        </div>
                    </div>

                    <!-- Right Panel: Results -->
                    <div class="modal-right">
                        <div class="results-toolbar">
                            <button id="recover-results-btn" class="btn-secondary" style="display: none;">
                                üíæ Recover Last Results
                            </button>
                        </div>
                        <div class="multi-agent-results">
                            <p style="text-align: center; color: #888; padding: 20px;">
                                Results will appear here after executing a workflow
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Auth UI Script -->
    <script type="module" src="auth-ui.js"></script>
    
    <!-- Phase 8: Video UI Integration -->
    <script type="module">
        import VideoUI from './video-ui.js';
        import { VideoHistoryUI } from './video-history-ui.js';
        import { VideoBatchUI } from './video-batch-ui.js';
        import { videoHistory } from './video-history-manager.js';
        import { videoCollections } from './video-collections-manager.js';
        
        // Initialize immediately - DOM is already loaded at this point (script at end of body)
        console.log('üé¨ Phase 8: Video UI script executing...');
        
        // Initialize managers
        await videoHistory.initialize();
        await videoCollections.initialize();
        
        const videoTabContent = document.getElementById('video-tab');
        if (videoTabContent) {
            new VideoUI(videoTabContent);
            console.log('‚úÖ Video UI initialized');
        } else {
            console.error('‚ùå video-tab element not found');
        }
        
        // Initialize History UI
        const historyContainer = document.getElementById('video-history-container');
        let videoHistoryUI = null;
        if (historyContainer) {
            videoHistoryUI = new VideoHistoryUI(historyContainer);
            console.log('‚úÖ Video History UI initialized');
        }
        
        // Initialize Batch UI
        const batchContainer = document.getElementById('batch-video-grid');
        let videoBatchUI = null;
        if (batchContainer) {
            videoBatchUI = new VideoBatchUI(batchContainer);
            console.log('‚úÖ Video Batch UI initialized');
        }
        
        // Main tab switching (Search / History / Batch / Current Video)
        const mainTabButtons = document.querySelectorAll('.video-main-tab');
        mainTabButtons.forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const tabName = btn.dataset.mainTab;
                console.log(`üîÑ Switching to main tab: ${tabName}`);
                
                // Remove active class from all main tabs
                mainTabButtons.forEach(b => {
                    b.classList.remove('active');
                    b.style.color = 'rgba(255,255,255,0.6)';
                    b.style.borderBottom = '3px solid transparent';
                });
                
                // Add active class to clicked tab
                btn.classList.add('active');
                btn.style.color = '#61dafb';
                btn.style.borderBottom = '3px solid #61dafb';
                
                // Hide all main tab contents
                document.querySelectorAll('.main-tab-content').forEach(content => {
                    content.style.display = 'none';
                });
                
                // Show selected main tab content
                const selectedTab = document.getElementById(`${tabName}-main-tab`);
                if (selectedTab) {
                    selectedTab.style.display = 'flex';
                    
                    // Render appropriate UI
                    if (tabName === 'history' && videoHistoryUI) {
                        videoHistoryUI.render();
                    } else if (tabName === 'batch' && videoBatchUI) {
                        videoBatchUI.render();
                    }
                }
            });
        });
        
        // Tab switching (for Current Video subtabs)
        const tabButtons = document.querySelectorAll('.ai-tab-btn');
        console.log(`üìë Found ${tabButtons.length} tab buttons`);
        
        tabButtons.forEach((btn, index) => {
            console.log(`  Tab ${index}: ${btn.dataset.tab}`);
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const tabName = btn.dataset.tab;
                console.log(`üîÑ Switching to tab: ${tabName}`);
                
                // Update buttons
                document.querySelectorAll('.ai-tab-btn').forEach(b => {
                    b.classList.remove('active');
                });
                btn.classList.add('active');
                
                // Update content
                document.querySelectorAll('.ai-tab-content').forEach(content => {
                    content.classList.remove('active');
                    content.style.display = 'none';
                });
                
                const activeContent = document.getElementById(`${tabName}-tab`);
                if (activeContent) {
                    activeContent.classList.add('active');
                    activeContent.style.display = 'flex';
                    console.log(`‚úÖ Tab ${tabName} activated`);
                } else {
                    console.error(`‚ùå Tab content not found: ${tabName}-tab`);
                }
            });
        });
    </script>

    <!-- Phase 8 Week 2: Content Creation Tools -->
    <script type="module">
        // Import docx library for Word export
        let docx;
        import('https://cdn.skypack.dev/docx@8.5.0').then(module => {
            docx = module;
            window.docx = module;
            console.log('‚úÖ docx library loaded from Skypack CDN');
        }).catch(err => {
            console.error('‚ùå Failed to load docx library:', err);
        });
        
        // Cache-busting: Add timestamp to force reload of module
        const cacheBuster = Date.now();
        import(`./video-content-tools.js?v=${cacheBuster}`).then(module => {
            const { VideoContentTools } = module;
            window.VideoContentTools = VideoContentTools;
            console.log('‚úÖ VideoContentTools loaded with cache buster:', cacheBuster);
        });
        
        // Store current video data and tools instance globally
        window.currentVideoData = null;
        window.currentTranscript = null;
        window.videoTools = null;
        
        // Initialize tools when transcript is loaded
        window.initializeVideoTools = function(videoData, transcript) {
            window.currentVideoData = videoData;
            window.currentTranscript = transcript;
            window.videoTools = new window.VideoContentTools(videoData, transcript);
            console.log('üé® Video Content Tools initialized');
        };
        
        // Generate Quiz from Video
        window.generateQuizFromVideo = async function() {
            if (!window.videoTools) {
                alert('Please load a video and transcript first!');
                return;
            }
            
            console.log('üìù Generating quiz...');
            showToolLoading('Generating Quiz', 'This may take 30-60 seconds...');
            
            try {
                const result = await window.videoTools.generateQuiz({
                    numMultipleChoice: 5,
                    numShortAnswer: 3,
                    numTrueFalse: 5,
                    numFillInBlank: 5,
                    difficulty: 'mixed',
                    includeTimestamps: true
                });
                
                showToolOutput('Quiz', result.markdown, result);
                console.log('‚úÖ Quiz generated successfully');
            } catch (error) {
                console.error('‚ùå Quiz generation failed:', error);
                alert('Failed to generate quiz: ' + error.message);
                backToToolsGrid();
            }
        };
        
        // Generate Lesson Plan from Video
        window.generateLessonPlanFromVideo = async function() {
            if (!window.videoTools) {
                alert('Please load a video and transcript first!');
                return;
            }
            
            console.log('üìö Generating lesson plan...');
            showToolLoading('Generating Lesson Plan', 'This may take 30-60 seconds...');
            
            try {
                const result = await window.videoTools.generateLessonPlan({
                    gradeLevel: '9-12',
                    duration: '45 minutes',
                    subject: 'General',
                    includeActivities: true,
                    includeDifferentiation: true
                });
                
                showToolOutput('Lesson Plan', result.markdown, result);
                console.log('‚úÖ Lesson plan generated successfully');
            } catch (error) {
                console.error('‚ùå Lesson plan generation failed:', error);
                alert('Failed to generate lesson plan: ' + error.message);
                backToToolsGrid();
            }
        };
        
        // Generate Discussion Questions from Video
        window.generateDiscussionQuestionsFromVideo = async function() {
            if (!window.videoTools) {
                alert('Please load a video and transcript first!');
                return;
            }
            
            console.log('üí¨ Generating discussion questions...');
            showToolLoading('Generating Discussion Questions', 'This may take 30-60 seconds...');
            
            try {
                const result = await window.videoTools.generateDiscussionQuestions({
                    numPerLevel: 3,
                    includeSocratic: true,
                    includeDebate: true
                });
                
                showToolOutput('Discussion Questions', result.markdown, result);
                console.log('‚úÖ Discussion questions generated successfully');
            } catch (error) {
                console.error('‚ùå Discussion questions generation failed:', error);
                alert('Failed to generate discussion questions: ' + error.message);
                backToToolsGrid();
            }
        };
        
        // Generate DOK 3-4 Project from Video
        window.generateDOKProjectFromVideo = async function() {
            if (!window.videoTools) {
                alert('Please load a video and transcript first!');
                return;
            }
            
            // Prompt user for DOK level and project type
            const dokLevel = prompt('Enter DOK Level (3 for Strategic Thinking, 4 for Extended Thinking):', '3');
            if (!dokLevel || (dokLevel !== '3' && dokLevel !== '4')) {
                alert('Please enter either 3 or 4 for DOK level');
                return;
            }
            
            const projectTypes = {
                '1': 'research',
                '2': 'design',
                '3': 'investigation',
                '4': 'synthesis'
            };
            
            const projectTypeChoice = prompt('Select Project Type:\n1. Research\n2. Design\n3. Investigation\n4. Synthesis\n\nEnter number (1-4):', '1');
            const projectType = projectTypes[projectTypeChoice] || 'research';
            
            console.log(`üéì Generating DOK ${dokLevel} ${projectType} project...`);
            showToolLoading(`Generating DOK ${dokLevel} Project`, 'Extended projects require 60-90 seconds...');
            
            try {
                const result = await window.videoTools.generateDOKProject({
                    dokLevel: parseInt(dokLevel),
                    projectType: projectType,
                    duration: dokLevel === '4' ? '2-3 weeks' : '1-2 weeks',
                    gradeLevel: '9-12',
                    subject: 'General'
                });
                
                showToolOutput(`DOK ${dokLevel} Project`, result.markdown, result);
                console.log('‚úÖ DOK project generated successfully');
            } catch (error) {
                console.error('‚ùå DOK project generation failed:', error);
                alert('Failed to generate DOK project: ' + error.message);
                backToToolsGrid();
            }
        };
        
        // Generate Vocabulary Builder from Video
        window.generateVocabularyFromVideo = async function() {
            if (!window.videoTools) {
                alert('Please load a video and transcript first!');
                return;
            }
            
            // Prompt user for grade level
            const gradeLevels = {
                '1': 'elementary school',
                '2': 'middle school',
                '3': 'high school',
                '4': 'college'
            };
            
            const gradeChoice = prompt('Select Grade Level:\n1. Elementary School (K-5)\n2. Middle School (6-8)\n3. High School (9-12)\n4. College\n\nEnter number (1-4):', '2');
            const gradeLevel = gradeLevels[gradeChoice] || 'middle school';
            
            console.log(`üìö Generating vocabulary list for ${gradeLevel}...`);
            showToolLoading('Generating Vocabulary List', 'Extracting key terms and definitions...');
            
            try {
                const result = await window.videoTools.generateVocabulary({
                    gradeLevel: gradeLevel,
                    numTerms: 15
                });
                
                showToolOutput('Vocabulary List', result.markdown, result);
                console.log('‚úÖ Vocabulary list generated successfully');
            } catch (error) {
                console.error('‚ùå Vocabulary generation failed:', error);
                alert('Failed to generate vocabulary: ' + error.message);
                backToToolsGrid();
            }
        };
        
        // Generate Guided Notes from Video
        window.generateGuidedNotesFromVideo = async function() {
            if (!window.videoTools) {
                alert('Please load a video and transcript first!');
                return;
            }
            
            // Prompt user for note style
            const noteStyles = {
                '1': 'cornell',
                '2': 'outline',
                '3': 'fillinblank',
                '4': 'guided'
            };
            
            const styleChoice = prompt('Select Note Style:\n1. Cornell Notes (questions + notes + summary)\n2. Outline (hierarchical structure)\n3. Fill-in-the-Blank (worksheets)\n4. Guided Questions (content + questions)\n\nEnter number (1-4):', '1');
            const noteStyle = noteStyles[styleChoice] || 'cornell';
            
            // Prompt for grade level
            const gradeLevels = {
                '1': 'elementary school',
                '2': 'middle school',
                '3': 'high school',
                '4': 'college'
            };
            
            const gradeChoice = prompt('Select Grade Level:\n1. Elementary School (K-5)\n2. Middle School (6-8)\n3. High School (9-12)\n4. College\n\nEnter number (1-4):', '2');
            const gradeLevel = gradeLevels[gradeChoice] || 'middle school';
            
            const styleNames = {
                cornell: 'Cornell Notes',
                outline: 'Outline',
                fillinblank: 'Fill-in-the-Blank',
                guided: 'Guided Questions'
            };
            
            console.log(`üìù Generating ${styleNames[noteStyle]} for ${gradeLevel}...`);
            showToolLoading(`Generating ${styleNames[noteStyle]}`, 'Creating structured note-taking template...');
            
            try {
                const result = await window.videoTools.generateGuidedNotes({
                    noteStyle: noteStyle,
                    gradeLevel: gradeLevel
                });
                
                showToolOutput(styleNames[noteStyle], result.markdown, result);
                console.log('‚úÖ Guided notes generated successfully');
            } catch (error) {
                console.error('‚ùå Guided notes generation failed:', error);
                alert('Failed to generate guided notes: ' + error.message);
                backToToolsGrid();
            }
        };
        
        // Generate Graphic Organizer from Video
        window.generateGraphicOrganizerFromVideo = async function() {
            if (!window.videoTools) {
                alert('Please load a video and transcript first!');
                return;
            }
            
            // Prompt user for organizer type
            const organizerTypes = {
                '1': 'Concept Map',
                '2': 'Timeline',
                '3': 'Venn Diagram',
                '4': 'Cause and Effect',
                '5': 'KWL Chart',
                '6': 'Mind Map'
            };
            
            const typeChoice = prompt('Select Graphic Organizer Type:\n1. Concept Map (central idea with connections)\n2. Timeline (chronological events)\n3. Venn Diagram (compare/contrast)\n4. Cause and Effect (relationships)\n5. KWL Chart (Know, Want, Learned)\n6. Mind Map (branching topics)\n\nEnter number (1-6):', '1');
            const organizerType = organizerTypes[typeChoice] || 'Concept Map';
            
            // Prompt for grade level
            const gradeLevels = {
                '1': 'elementary school',
                '2': 'middle school',
                '3': 'high school',
                '4': 'college'
            };
            
            const gradeChoice = prompt('Select Grade Level:\n1. Elementary School (K-5)\n2. Middle School (6-8)\n3. High School (9-12)\n4. College\n\nEnter number (1-4):', '2');
            const gradeLevel = gradeLevels[gradeChoice] || 'middle school';
            
            console.log(`üó∫Ô∏è Generating ${organizerType} for ${gradeLevel}...`);
            showToolLoading(`Generating ${organizerType}`, 'Creating visual learning organizer...');
            
            try {
                const result = await window.videoTools.generateGraphicOrganizer({
                    organizerType: organizerType,
                    gradeLevel: gradeLevel
                });
                
                showToolOutput(organizerType, result.markdown, result);
                console.log('‚úÖ Graphic organizer generated successfully');
            } catch (error) {
                console.error('‚ùå Graphic organizer generation failed:', error);
                alert('Failed to generate graphic organizer: ' + error.message);
                backToToolsGrid();
            }
        };
        
        // Show "Coming Soon" message for tools not yet implemented
        window.showComingSoon = function(toolName) {
            alert(`${toolName} will be available soon!\n\nPhase 8 Week 3 Nearly Complete:\n‚úÖ Quiz Maker\n‚úÖ Lesson Plan Generator\n‚úÖ Discussion Questions\n‚úÖ DOK 3-4 Projects\n‚úÖ Vocabulary Builder\n‚úÖ Guided Notes\n\nüöß Coming in final update:\n- Graphic Organizers`);
        };
        
        // Show loading state while generating
        function showToolLoading(toolName, message) {
            const grid = document.getElementById('create-tools-grid');
            const output = document.getElementById('create-tool-output');
            const title = document.getElementById('create-output-title');
            const content = document.getElementById('create-output-content');
            
            grid.style.display = 'none';
            output.style.display = 'flex';
            title.textContent = toolName;
            content.innerHTML = `
                <div style="text-align: center; padding: 60px 20px; color: #61dafb;">
                    <div class="spinner" style="margin: 0 auto 20px; width: 50px; height: 50px; border-width: 5px;"></div>
                    <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">Generating ${toolName}...</div>
                    <div style="font-size: 14px; color: rgba(255, 255, 255, 0.6);">${message}</div>
                    <div style="margin-top: 20px; font-size: 13px; color: rgba(255, 255, 255, 0.5);">
                        Using Claude Sonnet 4 with multi-agent intelligence
                    </div>
                </div>
            `;
        }
        
        // Show generated output
        function showToolOutput(toolName, markdownContent, fullResult) {
            const grid = document.getElementById('create-tools-grid');
            const output = document.getElementById('create-tool-output');
            const title = document.getElementById('create-output-title');
            const content = document.getElementById('create-output-content');
            
            console.log('üîç showToolOutput called:', { toolName, markdownLength: markdownContent?.length, fullResult });
            
            // Show output container, hide loading
            grid.style.display = 'none';
            output.style.display = 'flex';
            
            title.textContent = toolName;
            
            // Convert markdown to HTML for display
            const htmlContent = markdownToHTML(markdownContent);
            console.log('üîç Converted HTML length:', htmlContent?.length);
            console.log('üîç First 500 chars of HTML:', htmlContent?.substring(0, 500));
            content.innerHTML = htmlContent;
            console.log('üîç Content div innerHTML set, element:', content);
            
            // Store full result for export
            window.currentGeneratedContent = {
                toolName,
                markdown: markdownContent,
                raw: fullResult.raw,
                plainText: fullResult.plainText
            };
            
            // Scroll to top
            content.scrollTop = 0;
        }
        
        // Back to tools grid
        window.backToToolsGrid = function() {
            document.getElementById('create-tools-grid').style.display = 'grid';
            document.getElementById('create-tool-output').style.display = 'none';
            window.currentGeneratedContent = null;
        };
        
        // Copy content to clipboard
        window.copyCreatedContent = function() {
            if (!window.currentGeneratedContent) return;
            
            navigator.clipboard.writeText(window.currentGeneratedContent.markdown).then(() => {
                // Show success feedback
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚úÖ Copied!';
                btn.style.background = '#4caf50';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                }, 2000);
            });
        };
        
        // Export as Markdown file
        window.exportCreatedContentMarkdown = function() {
            if (!window.currentGeneratedContent) return;
            
            const content = window.currentGeneratedContent.markdown;
            const toolName = window.currentGeneratedContent.toolName;
            const filename = `${toolName}_${window.currentVideoData.videoId}_${Date.now()}.md`;
            
            const blob = new Blob([content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        };
        
        // Export as Word (.docx) file
        window.exportCreatedContentDocx = async function() {
            if (!window.currentGeneratedContent) return;
            
            // Check if docx library is loaded
            if (typeof docx === 'undefined') {
                alert('Word export library is still loading. Please wait a moment and try again.');
                console.error('docx library not loaded yet');
                return;
            }
            
            try {
                const { Document, Packer, Paragraph, TextRun, HeadingLevel, AlignmentType } = docx;
                
                const content = window.currentGeneratedContent.markdown;
                const toolName = window.currentGeneratedContent.toolName;
                const filename = `${toolName}_${window.currentVideoData.videoId}_${Date.now()}.docx`;
                
                // Clean markdown: remove excessive asterisks and clean up formatting
                const cleanedContent = content
                    .replace(/\*\*\*\*/g, '**')  // Remove quad asterisks
                    .replace(/\*\*\*/g, '**')     // Remove triple asterisks
                    .replace(/\n{3,}/g, '\n\n');  // Collapse multiple newlines
                
                // Parse markdown into document structure
                const paragraphs = [];
                const lines = cleanedContent.split('\n');
                
                // Add title
                paragraphs.push(
                    new Paragraph({
                        text: toolName,
                        heading: HeadingLevel.TITLE,
                        spacing: { after: 200 }
                    })
                );
                
                // Add video info
                if (window.currentVideoData) {
                    paragraphs.push(
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: `Video: ${window.currentVideoData.title}`,
                                    italics: true,
                                    size: 20
                                })
                            ],
                            spacing: { after: 400 }
                        })
                    );
                }
                
                // Parse markdown content
                const { Table, TableRow, TableCell, WidthType, BorderStyle } = docx;
                let inTable = false;
                let tableRows = [];
                
                console.log('üîç Starting markdown parsing. Total lines:', lines.length);
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    console.log(`Line ${i}:`, JSON.stringify(line.substring(0, 50)));
                    
                    if (!line) {
                        // If we're in a table, end it
                        if (inTable && tableRows.length > 0) {
                            paragraphs.push(createWordTable(tableRows));
                            inTable = false;
                            tableRows = [];
                        }
                        paragraphs.push(new Paragraph({ text: '' }));
                        continue;
                    }
                    
                    // Table separator line (|---|---|)
                    if (line.startsWith('|') && line.includes('-') && line.split('|').filter(c => c.trim()).every(c => c.match(/^-+$/))) {
                        continue; // Skip separator lines
                    }
                    
                    // Table row detection (| cell1 | cell2 |)
                    if (line.startsWith('|') && line.endsWith('|')) {
                        console.log('üìä Detected table row:', line);
                        const cells = line.split('|')
                            .map(c => c.trim())
                            .filter(c => c); // Remove empty strings from start/end
                        
                        console.log('   Parsed cells:', cells);
                        
                        if (cells.length > 0) {
                            if (!inTable) {
                                inTable = true;
                                tableRows = [];
                                console.log('   ‚úÖ Starting new table');
                            }
                            tableRows.push(cells);
                            continue;
                        }
                    }
                    
                    // If we were in a table and hit a non-table line, end the table
                    if (inTable && tableRows.length > 0) {
                        console.log('üèÅ Ending table with', tableRows.length, 'rows');
                        paragraphs.push(createWordTable(tableRows));
                        inTable = false;
                        tableRows = [];
                    }
                    
                    // Headers
                    if (line.startsWith('#### ')) {
                        paragraphs.push(new Paragraph({
                            text: line.substring(5),
                            heading: HeadingLevel.HEADING_4,
                            spacing: { before: 200, after: 100 }
                        }));
                    } else if (line.startsWith('### ')) {
                        paragraphs.push(new Paragraph({
                            text: line.substring(4),
                            heading: HeadingLevel.HEADING_3,
                            spacing: { before: 200, after: 100 }
                        }));
                    } else if (line.startsWith('## ')) {
                        paragraphs.push(new Paragraph({
                            text: line.substring(3),
                            heading: HeadingLevel.HEADING_2,
                            spacing: { before: 200, after: 100 }
                        }));
                    } else if (line.startsWith('# ')) {
                        paragraphs.push(new Paragraph({
                            text: line.substring(2),
                            heading: HeadingLevel.HEADING_1,
                            spacing: { before: 200, after: 100 }
                        }));
                    }
                    // List items
                    else if (line.startsWith('- ') || line.match(/^\d+\. /)) {
                        const text = line.replace(/^[-\d]+\.?\s/, '');
                        const textRuns = parseInlineFormatting(text);
                        paragraphs.push(new Paragraph({
                            children: textRuns,
                            bullet: { level: 0 },
                            spacing: { after: 100 }
                        }));
                    }
                    // Regular paragraphs
                    else {
                        const textRuns = parseInlineFormatting(line);
                        paragraphs.push(new Paragraph({
                            children: textRuns,
                            spacing: { after: 200 }
                        }));
                    }
                }
                
                // End any remaining table
                if (inTable && tableRows.length > 0) {
                    console.log('üèÅ Ending final table with', tableRows.length, 'rows');
                    paragraphs.push(createWordTable(tableRows));
                }
                
                console.log('‚úÖ Markdown parsing complete. Total paragraphs/tables:', paragraphs.length);
                
                // Helper function to create Word tables
                function createWordTable(rows) {
                    console.log('üî® Creating Word table with', rows.length, 'rows');
                    const wordRows = rows.map((row, rowIndex) => {
                        const cells = row.map(cellText => {
                            return new TableCell({
                                children: [new Paragraph({ 
                                    children: [new TextRun({ 
                                        text: cellText,
                                        bold: rowIndex === 0 // Bold header row
                                    })]
                                })],
                                shading: rowIndex === 0 ? { fill: "d9d9d9" } : undefined,
                                margins: {
                                    top: 100,
                                    bottom: 100,
                                    left: 100,
                                    right: 100
                                }
                            });
                        });
                        
                        return new TableRow({ children: cells });
                    });
                    
                    return new Table({
                        rows: wordRows,
                        width: { size: 100, type: WidthType.PERCENTAGE },
                        borders: {
                            top: { style: BorderStyle.SINGLE, size: 1 },
                            bottom: { style: BorderStyle.SINGLE, size: 1 },
                            left: { style: BorderStyle.SINGLE, size: 1 },
                            right: { style: BorderStyle.SINGLE, size: 1 },
                            insideHorizontal: { style: BorderStyle.SINGLE, size: 1 },
                            insideVertical: { style: BorderStyle.SINGLE, size: 1 }
                        }
                    });
                }
                
                // Helper function to parse bold/italic
                function parseInlineFormatting(text) {
                    const runs = [];
                    
                    // Clean up excessive asterisks first
                    text = text.replace(/\*{4,}/g, '**');  // 4+ asterisks -> bold
                    text = text.replace(/\*{3}/g, '**');    // 3 asterisks -> bold
                    
                    // Simple regex for **bold** and *italic*
                    const boldRegex = /\*\*(.*?)\*\*/g;
                    const italicRegex = /(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g;
                    
                    // Replace bold first
                    text = text.replace(boldRegex, (match, content) => {
                        return `<BOLD>${content}</BOLD>`;
                    });
                    
                    // Replace italic (but not bold markers)
                    text = text.replace(italicRegex, (match, content) => {
                        if (content.includes('<BOLD>')) return match;
                        return `<ITALIC>${content}</ITALIC>`;
                    });
                    
                    // Parse the modified text
                    const parts = text.split(/(<BOLD>.*?<\/BOLD>|<ITALIC>.*?<\/ITALIC>)/);
                    
                    for (const part of parts) {
                        if (!part) continue;
                        
                        if (part.startsWith('<BOLD>')) {
                            const content = part.replace(/<\/?BOLD>/g, '');
                            runs.push(new TextRun({ text: content, bold: true }));
                        } else if (part.startsWith('<ITALIC>')) {
                            const content = part.replace(/<\/?ITALIC>/g, '');
                            runs.push(new TextRun({ text: content, italics: true }));
                        } else {
                            // Remove any remaining asterisks
                            const cleaned = part.replace(/\*/g, '');
                            if (cleaned) {
                                runs.push(new TextRun({ text: cleaned }));
                            }
                        }
                    }
                    
                    return runs.length > 0 ? runs : [new TextRun({ text: text })];
                }
                
                // Create document
                const doc = new Document({
                    sections: [{
                        properties: {},
                        children: paragraphs
                    }]
                });
                
                // Generate and download
                const blob = await Packer.toBlob(doc);
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
                
                console.log('‚úÖ Word document downloaded successfully:', filename);
                
            } catch (error) {
                console.error('Error exporting to Word:', error);
                alert('Failed to export to Word: ' + error.message);
            }
        };
        
        // Create in Google Docs (placeholder for Phase 10)
        window.createInGoogleDocs = function() {
            alert('üìù Google Docs Live Integration\n\nThis feature will be available in Phase 10!\n\nIt will allow you to:\n‚úì Click "Create in Google Docs"\n‚úì Watch document generate line-by-line\n‚úì Auto-save to your Google Drive\n‚úì Continue editing in Google Docs\n\nFor now, use "Copy" or "Markdown" to export.');
        };
        
        // Simple markdown to HTML converter
        function markdownToHTML(markdown) {
            if (!markdown) return '';
            
            let html = markdown;
            
            // Tables (must be done BEFORE other replacements)
            const lines = html.split('\n');
            let inTable = false;
            let tableHTML = '';
            let processedLines = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // Check if this is a table row (| cell1 | cell2 |)
                if (line.startsWith('|') && line.endsWith('|')) {
                    // Skip separator lines (|---|---|)
                    if (line.match(/^\|[\s:-]+\|$/)) {
                        continue;
                    }
                    
                    // Parse cells
                    const cells = line
                        .substring(1, line.length - 1) // Remove leading/trailing pipes
                        .split('|')
                        .map(cell => cell.trim());
                    
                    if (!inTable) {
                        // Start new table
                        inTable = true;
                        tableHTML = '<table class="cornell-table" style="width: 100%; border-collapse: collapse; margin: 15px 0;">';
                        tableHTML += '<thead><tr>';
                        cells.forEach(cell => {
                            tableHTML += `<th style="border: 1px solid #ddd; padding: 12px; background: #f5f5f5; font-weight: bold; text-align: left;">${cell}</th>`;
                        });
                        tableHTML += '</tr></thead><tbody>';
                    } else {
                        // Add data row
                        tableHTML += '<tr>';
                        cells.forEach(cell => {
                            tableHTML += `<td style="border: 1px solid #ddd; padding: 12px; vertical-align: top;">${cell}</td>`;
                        });
                        tableHTML += '</tr>';
                    }
                } else {
                    // Not a table line
                    if (inTable) {
                        // Close the table
                        tableHTML += '</tbody></table>';
                        processedLines.push(tableHTML);
                        tableHTML = '';
                        inTable = false;
                    }
                    processedLines.push(line);
                }
            }
            
            // Close any remaining table
            if (inTable) {
                tableHTML += '</tbody></table>';
                processedLines.push(tableHTML);
            }
            
            html = processedLines.join('\n');
            
            // Headers (must be done first, in reverse order)
            html = html.replace(/^#### (.*$)/gim, '<h4>$1</h4>');
            html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
            html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
            html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
            
            // Bold
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Italic
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Links
            html = html.replace(/\[([^\]]+)\]\(([^\)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
            
            // Horizontal rules
            html = html.replace(/^---+$/gm, '<hr/>');
            
            // Unordered lists
            html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
            
            // Ordered lists  
            html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
            
            // Wrap consecutive <li> in <ul>
            html = html.replace(/(<li>.*?<\/li>\n?)+/g, function(match) {
                return '<ul>' + match + '</ul>';
            });
            
            // Paragraphs (split by double newlines)
            html = html.split('\n\n').map(para => {
                // Skip if already wrapped in a tag
                if (para.match(/^<[^>]+>/)) {
                    return para;
                }
                return '<p>' + para + '</p>';
            }).join('\n');
            
            // Single line breaks to <br>
            html = html.replace(/\n/g, '<br/>');
            
            return html;
        }
    </script>

    <!-- Full-Screen Video Intelligence Modal -->
    <div id="video-full-modal" class="multi-agent-modal" style="display: none;">
        <div class="modal-content" style="max-width: 98vw; width: 98vw; height: 98vh; display: flex; flex-direction: column; overflow: hidden;">
            <div class="modal-header" style="flex-shrink: 0;">
                <h2>üé¨ YouTube Video Intelligence</h2>
                <button class="modal-close" id="video-full-modal-close">&times;</button>
            </div>
            
            <!-- Main Tabs (Search / History / Batch / Current Video) -->
            <div class="video-main-tabs" style="display: flex; gap: 8px; padding: 0 20px; border-bottom: 2px solid rgba(97, 218, 251, 0.2); flex-shrink: 0;">
                <button class="video-main-tab active" data-main-tab="search" style="padding: 12px 20px; background: none; border: none; color: #61dafb; font-size: 15px; font-weight: bold; border-bottom: 3px solid #61dafb; cursor: pointer;">üîç Search/Load</button>
                <button class="video-main-tab" data-main-tab="history" style="padding: 12px 20px; background: none; border: none; color: rgba(255,255,255,0.6); font-size: 15px; font-weight: bold; border-bottom: 3px solid transparent; cursor: pointer;">üìö History</button>
                <button class="video-main-tab" data-main-tab="batch" style="padding: 12px 20px; background: none; border: none; color: rgba(255,255,255,0.6); font-size: 15px; font-weight: bold; border-bottom: 3px solid transparent; cursor: pointer;">üì¶ Batch</button>
                <button class="video-main-tab" data-main-tab="current" style="padding: 12px 20px; background: none; border: none; color: rgba(255,255,255,0.6); font-size: 15px; font-weight: bold; border-bottom: 3px solid transparent; cursor: pointer;">üì∫ Current Video</button>
            </div>
            
            <div class="modal-body" style="flex: 1; display: flex; flex-direction: column; gap: 15px; overflow: hidden; padding: 20px;">
                
                <!-- SEARCH/LOAD TAB -->
                <div id="search-main-tab" class="main-tab-content" style="display: flex; flex-direction: column; gap: 15px; height: 100%;">
                    <!-- Search/Load Bar -->
                    <div style="display: flex; gap: 10px; flex-shrink: 0;">
                        <input 
                            type="text" 
                            id="video-modal-input" 
                            class="search-input" 
                            placeholder="Search YouTube or paste video URL/ID..."
                            style="flex: 1; padding: 12px; font-size: 14px;"
                        />
                        <button id="video-modal-search-btn" class="primary-button" style="padding: 12px 20px; white-space: nowrap;">üîç Search</button>
                        <button id="video-modal-load-btn" class="primary-button" style="padding: 12px 20px; white-space: nowrap;">‚ñ∂ Load</button>
                    </div>

                    <!-- Search Results (collapsible) -->
                    <div id="video-modal-search-results-container" style="display: none; flex-shrink: 0;">
                        <h3 style="margin: 0 0 10px 0; color: #61dafb; font-size: 16px;">Search Results</h3>
                        <div id="video-modal-search-results" style="max-height: 250px; overflow-y: scroll; display: block; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 10px; background: rgba(0,0,0,0.3);"></div>
                    </div>
                </div>
                
                <!-- HISTORY TAB -->
                <div id="history-main-tab" class="main-tab-content" style="display: none; height: 100%; flex-direction: column; overflow: hidden;">
                    <div id="video-history-container" style="height: 100%; display: flex; flex-direction: column;"></div>
                </div>
                
                <!-- BATCH TAB -->
                <div id="batch-main-tab" class="main-tab-content" style="display: none; height: 100%; flex-direction: column; overflow: hidden;">
                    
                    <!-- Batch Controls -->
                    <div style="padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); flex-shrink: 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div>
                                <h3 style="margin: 0 0 4px 0; font-size: 16px; color: #61dafb;">Batch Operations</h3>
                                <p style="margin: 0; font-size: 12px; color: #999;">Select 5-10 videos to generate combined study materials</p>
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <span id="batch-selected-count" style="font-size: 13px; color: #61dafb; font-weight: bold;">0 selected</span>
                                <button id="batch-select-all" style="padding: 6px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: #999; cursor: pointer; font-size: 12px;">Select All</button>
                                <button id="batch-deselect-all" style="padding: 6px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: #999; cursor: pointer; font-size: 12px;">Deselect All</button>
                            </div>
                        </div>
                        
                        <!-- Batch Actions -->
                        <div style="display: flex; gap: 10px;">
                            <button class="batch-action-btn" data-action="weekly-summary" disabled style="flex: 1; padding: 10px; background: rgba(97, 218, 251, 0.1); border: 1px solid rgba(97, 218, 251, 0.3); border-radius: 6px; color: rgba(97, 218, 251, 0.5); cursor: not-allowed; font-size: 13px; font-weight: bold;">
                                üìä Weekly Summary
                            </button>
                            <button class="batch-action-btn" data-action="combined-quiz" disabled style="flex: 1; padding: 10px; background: rgba(97, 218, 251, 0.1); border: 1px solid rgba(97, 218, 251, 0.3); border-radius: 6px; color: rgba(97, 218, 251, 0.5); cursor: not-allowed; font-size: 13px; font-weight: bold;">
                                üìù Combined Quiz
                            </button>
                            <button class="batch-action-btn" data-action="master-vocabulary" disabled style="flex: 1; padding: 10px; background: rgba(97, 218, 251, 0.1); border: 1px solid rgba(97, 218, 251, 0.3); border-radius: 6px; color: rgba(97, 218, 251, 0.5); cursor: not-allowed; font-size: 13px; font-weight: bold;">
                                üìñ Master Vocabulary
                            </button>
                            <button class="batch-action-btn" data-action="unit-study-guide" disabled style="flex: 1; padding: 10px; background: rgba(97, 218, 251, 0.1); border: 1px solid rgba(97, 218, 251, 0.3); border-radius: 6px; color: rgba(97, 218, 251, 0.5); cursor: not-allowed; font-size: 13px; font-weight: bold;">
                                üìö Unit Study Guide
                            </button>
                        </div>
                    </div>
                    
                    <!-- Batch Video Grid -->
                    <div id="batch-video-grid" style="flex: 1; overflow-y: auto; padding: 15px;"></div>
                    
                    <!-- Batch Output Modal (hidden) -->
                    <div id="batch-output-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 20000; padding: 40px;">
                        <div style="background: #1e1e1e; border-radius: 12px; max-width: 1200px; margin: 0 auto; height: 100%; display: flex; flex-direction: column; overflow: hidden;">
                            <div style="padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; display: flex; justify-content: space-between; align-items: center;">
                                <h3 id="batch-output-title" style="margin: 0; color: #61dafb; font-size: 20px;"></h3>
                                <div style="display: flex; gap: 10px;">
                                    <button id="batch-copy-btn" style="padding: 8px 16px; background: rgba(97, 218, 251, 0.2); border: 1px solid #61dafb; border-radius: 6px; color: #61dafb; cursor: pointer; font-size: 13px;">üìã Copy</button>
                                    <button id="batch-export-btn" style="padding: 8px 16px; background: rgba(97, 218, 251, 0.2); border: 1px solid #61dafb; border-radius: 6px; color: #61dafb; cursor: pointer; font-size: 13px;">üíæ Export</button>
                                    <button id="batch-close-btn" style="padding: 8px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #999; cursor: pointer; font-size: 13px;">‚úï Close</button>
                                </div>
                            </div>
                            <div id="batch-output-content" style="flex: 1; overflow-y: auto; padding: 30px; color: #fff; line-height: 1.8;"></div>
                        </div>
                    </div>
                    
                </div>
                
                <!-- CURRENT VIDEO TAB -->

                
                <!-- CURRENT VIDEO TAB -->
                <div id="current-main-tab" class="main-tab-content" style="display: none; height: 100%; overflow: hidden;">
                    
                <!-- Video Content (hidden until loaded) - SIDE BY SIDE LAYOUT -->
                <div id="video-modal-content" style="display: none; flex: 1; overflow: hidden; height: 100%;">
                    <div style="display: flex; gap: 20px; height: 100%;">
                        
                        <!-- LEFT SIDE: Video Player + Info (55% width) -->
                        <div style="flex: 0 0 55%; display: flex; flex-direction: column; gap: 15px; min-width: 0;">
                            
                            <!-- Video Player with Fullscreen Button -->
                            <div style="position: relative; background: #000; border-radius: 8px; overflow: hidden; flex-shrink: 0;">
                                <iframe 
                                    id="video-modal-iframe"
                                    width="100%" 
                                    height="450" 
                                    frameborder="0" 
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen" 
                                    allowfullscreen>
                                </iframe>
                                <button id="video-fullscreen-btn" class="secondary-button" style="position: absolute; top: 10px; right: 10px; padding: 8px 12px; font-size: 13px; background: rgba(0,0,0,0.8); border: 1px solid rgba(255,255,255,0.3); z-index: 100; cursor: pointer;">
                                    ‚õ∂ Fullscreen
                                </button>
                            </div>
                            
                            <!-- Video Info -->
                            <div style="padding: 15px; background: rgba(255,255,255,0.02); border-radius: 8px; flex-shrink: 0;">
                                <h3 id="video-modal-title" style="margin: 0 0 10px 0; color: #fff; font-size: 18px; line-height: 1.4;"></h3>
                                <div style="display: flex; gap: 15px; color: #888; font-size: 14px; flex-wrap: wrap;">
                                    <span id="video-modal-author"></span>
                                    <span id="video-modal-duration"></span>
                                    <span id="video-modal-views"></span>
                                </div>
                            </div>
                        </div>

                        <!-- RIGHT SIDE: Tabs and Content (45% width) -->
                        <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden; min-width: 0;">
                            
                            <!-- Tabs -->
                            <div class="tabs" style="margin-bottom: 15px; flex-shrink: 0; display: flex; gap: 8px; flex-wrap: wrap;">
                                <button class="tab-button active" data-tab="transcript" style="padding: 10px 16px; font-size: 14px;">üìù Transcript</button>
                                <button class="tab-button" data-tab="summary" style="padding: 10px 16px; font-size: 14px;">‚ö° Summary</button>
                                <button class="tab-button" data-tab="analysis" style="padding: 10px 16px; font-size: 14px;">üß† Analysis</button>
                                <button class="tab-button" data-tab="stats" style="padding: 10px 16px; font-size: 14px;">üìä Stats</button>
                                <button class="tab-button" data-tab="search-transcript" style="padding: 10px 16px; font-size: 14px;">üîç Search</button>
                                <button class="tab-button" data-tab="create" style="padding: 10px 16px; font-size: 14px; background: rgba(97, 218, 251, 0.2); border-color: #61dafb; font-weight: bold;">üé® Create</button>
                            </div>

                            <!-- Tab Content Container -->
                            <div style="flex: 1; overflow: hidden;">
                                
                                <!-- Transcript Tab -->
                                <div id="transcript-tab" class="tab-content active" style="height: 100%; display: flex; flex-direction: column; overflow: hidden;">
                                    <div id="video-modal-transcript" style="flex: 1; overflow-y: auto; display: block; padding: 20px; background: rgba(255,255,255,0.02); border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); font-size: 14px; line-height: 1.8;">
                                        <div class="transcript-placeholder" style="color: #888; text-align: center; padding: 40px 20px;">Click "Load Transcript" to fetch captions</div>
                                    </div>
                                    <button id="video-modal-load-transcript-btn" class="primary-button" style="margin-top: 15px; padding: 12px; font-size: 15px; flex-shrink: 0;">
                                        üì• Load Transcript
                                    </button>
                                </div>

                                <!-- Summary Tab -->
                                <div id="summary-tab" class="tab-content" style="display: none; height: 100%; flex-direction: column; overflow: hidden;">
                                    <div id="video-modal-summary" style="flex: 1; overflow-y: auto; display: block; padding: 20px; background: rgba(255,255,255,0.02); border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); font-size: 14px; line-height: 1.8;">
                                        <div class="summary-placeholder" style="color: #888; text-align: center; padding: 40px 20px;">Load transcript first, then click "Generate Summary"</div>
                                    </div>
                                    <button id="video-modal-generate-summary-btn" class="primary-button" style="margin-top: 15px; padding: 12px; font-size: 15px; display: none; flex-shrink: 0;">
                                        <span class="icon">‚ú®</span> Generate AI Summary
                                    </button>
                                </div>

                                <!-- Analysis Tab -->
                                <div id="analysis-tab" class="tab-content" style="display: none; height: 100%; overflow: hidden;">
                                    <div id="video-modal-analysis" style="height: 100%; overflow-y: auto; display: block; padding: 20px; background: rgba(255,255,255,0.02); border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); font-size: 14px; line-height: 1.8;">
                                        <div class="analysis-placeholder" style="color: #888; text-align: center; padding: 40px 20px;">Generate summary first to see multi-agent analysis</div>
                                    </div>
                                </div>

                                <!-- Statistics Tab -->
                                <div id="stats-tab" class="tab-content" style="display: none; height: 100%; overflow-y: auto;">
                                    <div id="video-modal-stats" style="padding: 20px; background: rgba(255,255,255,0.02); border-radius: 8px; font-size: 14px;"></div>
                                </div>

                                <!-- Search Transcript Tab -->
                                <div id="search-transcript-tab" class="tab-content" style="display: none; height: 100%; flex-direction: column; overflow: hidden;">
                                    <div class="search-controls" style="margin-bottom: 15px; display: flex; gap: 10px; flex-shrink: 0;">
                                        <input 
                                            type="text" 
                                            id="video-modal-transcript-search" 
                                            class="search-input" 
                                            placeholder="Search in transcript..."
                                            style="flex: 1; padding: 10px; font-size: 14px;"
                                        />
                                        <button id="video-modal-search-transcript-btn" class="primary-button" style="padding: 10px 20px; white-space: nowrap;">Search</button>
                                    </div>
                                    <div id="video-modal-transcript-search-results" style="flex: 1; overflow-y: auto; padding: 20px; background: rgba(255,255,255,0.02); border-radius: 8px; font-size: 14px;"></div>
                                </div>

                                <!-- CREATE TAB - Phase 8 Week 2: Content Creation Tools -->
                                <div id="create-tab" class="tab-content" style="display: none; height: 100%; flex-direction: column; overflow: hidden;">
                                    
                                    <!-- Tools Grid (shown initially) -->
                                    <div id="create-tools-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; padding: 20px; overflow-y: auto;">
                                        
                                        <button class="tool-card" onclick="generateQuizFromVideo()" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(97, 218, 251, 0.2); border-radius: 12px; padding: 24px; text-align: center; cursor: pointer; transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; gap: 12px;">
                                            <div class="tool-icon" style="font-size: 48px;">üìù</div>
                                            <div class="tool-name" style="font-size: 16px; font-weight: bold; color: #61dafb;">Quiz</div>
                                            <div class="tool-desc" style="font-size: 13px; color: rgba(255, 255, 255, 0.7); line-height: 1.4;">Multiple choice, short answer, true/false, fill-in-blank</div>
                                        </button>
                                        
                                        <button class="tool-card" onclick="generateLessonPlanFromVideo()" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(97, 218, 251, 0.2); border-radius: 12px; padding: 24px; text-align: center; cursor: pointer; transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; gap: 12px;">
                                            <div class="tool-icon" style="font-size: 48px;">üìö</div>
                                            <div class="tool-name" style="font-size: 16px; font-weight: bold; color: #61dafb;">Lesson Plan</div>
                                            <div class="tool-desc" style="font-size: 13px; color: rgba(255, 255, 255, 0.7); line-height: 1.4;">Complete lesson with objectives, activities, assessment</div>
                                        </button>
                                        
                                        <button class="tool-card" onclick="generateDiscussionQuestionsFromVideo()" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(97, 218, 251, 0.2); border-radius: 12px; padding: 24px; text-align: center; cursor: pointer; transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; gap: 12px;">
                                            <div class="tool-icon" style="font-size: 48px;">üí¨</div>
                                            <div class="tool-name" style="font-size: 16px; font-weight: bold; color: #61dafb;">Discussion Questions</div>
                                            <div class="tool-desc" style="font-size: 13px; color: rgba(255, 255, 255, 0.7); line-height: 1.4;">Socratic questions, Bloom's taxonomy, debate topics</div>
                                        </button>
                                        
                                        <button class="tool-card" onclick="generateGuidedNotesFromVideo()" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(97, 218, 251, 0.2); border-radius: 12px; padding: 24px; text-align: center; cursor: pointer; transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; gap: 12px;">
                                            <div class="tool-icon" style="font-size: 48px;">üìã</div>
                                            <div class="tool-name" style="font-size: 16px; font-weight: bold; color: #61dafb;">Guided Notes</div>
                                            <div class="tool-desc" style="font-size: 13px; color: rgba(255, 255, 255, 0.7); line-height: 1.4;">Cornell notes, outlines, fill-in-blank worksheets</div>
                                        </button>                                            <div style="font-size: 11px; color: #ffa500; font-weight: bold;">COMING SOON</div>
                                        </button>
                                        
                                        <button class="tool-card" onclick="generateVocabularyFromVideo()" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(97, 218, 251, 0.2); border-radius: 12px; padding: 24px; text-align: center; cursor: pointer; transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; gap: 12px;">
                                            <div class="tool-icon" style="font-size: 48px;">üìñ</div>
                                            <div class="tool-name" style="font-size: 16px; font-weight: bold; color: #61dafb;">Vocabulary</div>
                                            <div class="tool-desc" style="font-size: 13px; color: rgba(255, 255, 255, 0.7); line-height: 1.4;">Key terms, definitions, flashcards</div>
                                        </button>
                                        
                                        <button class="tool-card" onclick="generateGraphicOrganizerFromVideo()" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(97, 218, 251, 0.2); border-radius: 12px; padding: 24px; text-align: center; cursor: pointer; transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; gap: 12px;">
                                            <div class="tool-icon" style="font-size: 48px;">üó∫Ô∏è</div>
                                            <div class="tool-name" style="font-size: 16px; font-weight: bold; color: #61dafb;">Graphic Organizer</div>
                                            <div class="tool-desc" style="font-size: 13px; color: rgba(255, 255, 255, 0.7); line-height: 1.4;">Concept maps, timelines, Venn diagrams, KWL charts</div>
                                        </button>
                                        
                                        <button class="tool-card" onclick="generateDOKProjectFromVideo()" style="background: linear-gradient(135deg, rgba(156, 39, 176, 0.2), rgba(103, 58, 183, 0.2)); border: 2px solid rgba(156, 39, 176, 0.5); border-radius: 12px; padding: 24px; text-align: center; cursor: pointer; transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; gap: 12px;">
                                            <div class="tool-icon" style="font-size: 48px;">üéì</div>
                                            <div class="tool-name" style="font-size: 16px; font-weight: bold; color: #ce93d8;">DOK 3-4 Project</div>
                                            <div class="tool-desc" style="font-size: 13px; color: rgba(255, 255, 255, 0.7); line-height: 1.4;">Strategic & extended thinking projects</div>
                                            <div style="font-size: 11px; color: #ffeb3b; font-weight: bold;">‚ú® NEW</div>
                                        </button>
                                        
                                    </div>
                                    
                                    <!-- Tool Output (hidden initially, shown after generation) -->
                                    <div id="create-tool-output" style="display: none; flex-direction: column; height: 100%; overflow: hidden;">
                                        
                                        <!-- Output Header with Back Button and Export Options -->
                                        <div id="create-output-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 15px; background: rgba(97, 218, 251, 0.1); border-radius: 8px; flex-shrink: 0;">
                                            <div style="display: flex; align-items: center; gap: 12px;">
                                                <button onclick="backToToolsGrid()" class="secondary-button" style="padding: 8px 16px; font-size: 14px;">‚Üê Back</button>
                                                <h3 id="create-output-title" style="margin: 0; color: #61dafb; font-size: 18px;">Generated Content</h3>
                                            </div>
                                            <div style="display: flex; gap: 8px;">
                                                <button onclick="copyCreatedContent()" class="secondary-button" style="padding: 8px 16px; font-size: 14px;">üìã Copy</button>
                                                <button onclick="exportCreatedContentMarkdown()" class="secondary-button" style="padding: 8px 16px; font-size: 14px;">üìÑ Markdown</button>
                                                <button onclick="exportCreatedContentDocx()" class="primary-button" style="padding: 8px 16px; font-size: 14px; background: #2b5797; font-weight: bold;" title="Export to Microsoft Word format">
                                                    üìÑ Word (.docx)
                                                </button>
                                                <button onclick="createInGoogleDocs()" class="secondary-button" style="padding: 8px 16px; font-size: 14px; opacity: 0.5;" title="Coming in Phase 10">
                                                    üìù Google Docs (Phase 10)
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- Output Content (scrollable) -->
                                        <div id="create-output-content" style="flex: 1; overflow-y: auto; padding: 20px; background: rgba(255, 255, 255, 0.02); border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.05); font-size: 14px; line-height: 1.8;">
                                            <!-- Generated content appears here -->
                                        </div>
                                        
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                </div><!-- END CURRENT VIDEO TAB -->
                
            </div><!-- END modal-body -->
        </div>
    </div>

    <!-- üé® DIAGRAM RENDERING LIBRARIES (Phase 8 Week 3: Visual Rendering) -->
    
    <!-- Mermaid.js - Flowcharts and Cause/Effect diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    
    <!-- D3.js - Required for d3-venn -->
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    
    <!-- d3-venn - Venn Diagrams with perfect overlapping circles -->
    <script src="https://cdn.jsdelivr.net/npm/@upsetjs/venn.js@1.4.1/build/venn.min.js"></script>
    
    <!-- vis-timeline - Professional interactive timelines -->
    <link href="https://unpkg.com/vis-timeline@7.7.3/styles/vis-timeline-graph2d.min.css" rel="stylesheet" type="text/css" />
    <script src="https://unpkg.com/vis-timeline@7.7.3/standalone/umd/vis-timeline-graph2d.min.js"></script>
    
    <!-- Cytoscape.js - Network graphs for Concept Maps -->
    <script src="https://cdn.jsdelivr.net/npm/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
    
    <!-- markmap - Use CDN that exposes globals properly -->
    <script src="https://cdn.jsdelivr.net/npm/markmap-autoloader@0.16.0"></script>
    
    <!-- Initialize Mermaid -->
    <script>
        if (typeof mermaid !== 'undefined') {
            mermaid.initialize({
                startOnLoad: false,
                theme: 'dark',
                themeVariables: {
                    primaryColor: '#61dafb',
                    primaryTextColor: '#fff',
                    primaryBorderColor: '#61dafb',
                    lineColor: '#61dafb',
                    secondaryColor: '#282c34',
                    tertiaryColor: '#20232a'
                },
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true,
                    curve: 'basis'
                }
            });
            console.log('‚úÖ Mermaid.js initialized');
        }
        
        // Verify all diagram libraries loaded
        setTimeout(() => {
            console.log('üîç Diagram library check:');
            console.log('  Mermaid:', typeof mermaid !== 'undefined' ? '‚úÖ' : '‚ùå');
            console.log('  D3:', typeof d3 !== 'undefined' ? '‚úÖ' : '‚ùå');
            console.log('  d3-venn (venn):', typeof venn !== 'undefined' ? '‚úÖ' : '‚ùå');
            console.log('  d3-venn (vennjs):', typeof vennjs !== 'undefined' ? '‚úÖ' : '‚ùå');
            console.log('  d3-venn (window.venn):', window.venn ? '‚úÖ' : '‚ùå');
            console.log('  vis-timeline:', typeof vis !== 'undefined' ? '‚úÖ' : '‚ùå');
            console.log('  Cytoscape:', typeof cytoscape !== 'undefined' ? '‚úÖ' : '‚ùå');
            console.log('  markmap:', typeof markmap !== 'undefined' ? '‚úÖ' : '‚ùå');
            console.log('  markmap (window):', window.markmap ? '‚úÖ' : '‚ùå');
        }, 1000);
    </script>

    <!-- Diagram Renderers Module -->
    <script type="module" src="diagram-renderers.js"></script>

</body>
</html>
